---
title: "Association between Frailty Index Based on Laboratory Tests and All-cause Mortality in Critically Ill Patients with AKI"
format: html
editor: visual
---

## Quarto

Quarto enables you to weave together content and executable code into a finished document. To learn more about Quarto see <https://quarto.org>.

## Running Code

When you click the **Render** button a document will be generated that includes both content and the output of embedded code. You can embed code like this:

# å¯¼å…¥æ•°æ®

```{r}
# å®‰è£…å¹¶åŠ è½½å¿…è¦çš„åŒ…
if(!require(haven)) install.packages("haven")
library(haven)
if(!require(readxl)) install.packages("readxl")  # å¦‚æœå°šæœªå®‰è£…
library(readxl)
# è¯»å–SASæ•°æ®é›†
fi_lab <- read_sas("ads/fi_lab.sas7bdat")
tte <- read_sas("ads/tte.sas7bdat")

# è¯»å–å…ƒæ•°æ®
metadata <- read_excel("fi_lab_metadata.xlsx")
```

# **missForest ç¼ºå¤±å€¼æ’è¡¥**

## æŸ¥çœ‹æ•°æ®ç¼ºå¤±æƒ…å†µï¼š

<!--# bmi, sofaéƒ¨åˆ†ç¼ºå¤± -->

```{r}
if(!require(mice)) install.packages("mice")  # ç”¨äºç»“æœæ¯”è¾ƒå’Œè¯„ä¼°
if(!require(VIM)) install.packages("VIM") # ç”¨äºå¯è§†åŒ–ç¼ºå¤±æ•°æ®
if(!require(dplyr)) install.packages("dplyr")
library(mice)
library(VIM)
library(dplyr)

# æŸ¥çœ‹æ•°æ®ç»“æ„
str(fi_lab)
# è¯»å–æ•°æ®
check_data <-fi_lab %>%
  select(-all_of(c("Q1","Q2","Q3","subject_id","stay_id","hadm_id","total_number","total_deficit", "flab","keep")))
# æ£€æŸ¥ç¼ºå¤±æ•°æ®æ¨¡å¼
summary(check_data)  # æŸ¥çœ‹å„å˜é‡ç¼ºå¤±æƒ…å†µ
md.pattern(check_data)  # å¯è§†åŒ–ç¼ºå¤±æ¨¡å¼
# å¯è§†åŒ–ç¼ºå¤±æ•°æ®
aggr_plot <- aggr(check_data, col=c('navyblue','red'), 
                  numbers=TRUE, sortVars=TRUE,
                  labels=names(check_data), cex.axis=.7,
                  gap=3, ylab=c("Missing data pattern","Pattern"))

#Remove if missing>20%
#Check no missing >20%
```

## ç¼ºå¤±æ•°æ®æ±‡æ€»é™„è¡¨

```{r}
# åŠ è½½å¿…è¦çš„åŒ…
if(!require(mice)) install.packages("mice")
if(!require(VIM)) install.packages("VIM")
if(!require(dplyr)) install.packages("dplyr")
if(!require(flextable)) install.packages("flextable")
if(!require(officer)) install.packages("officer")
if(!require(tidyr)) install.packages("tidyr")

library(mice)
library(VIM)
library(dplyr)
library(flextable)
library(officer)
library(tidyr)

# æŸ¥çœ‹æ•°æ®ç»“æ„
str(fi_lab)

# è¯»å–æ•°æ®ï¼ˆä¿æŒæ‚¨åŸæœ‰çš„æ•°æ®å¤„ç†ï¼‰
check_data <- fi_lab %>%
  select(-all_of(c("Q1","Q2","Q3","subject_id","stay_id","hadm_id","total_number","total_deficit", "flab","keep")))

# æ£€æŸ¥ç¼ºå¤±æ•°æ®æ¨¡å¼
summary(check_data)
md.pattern(check_data)

# å®‰å…¨çš„å¯è§†åŒ–ç¼ºå¤±æ•°æ®ï¼ˆé¿å…å›¾å½¢å‚æ•°é”™è¯¯ï¼‰
plot_missing_data <- function(data) {
  tryCatch({
    # æ¸…ç†å›¾å½¢ç¯å¢ƒ
    while (!is.null(dev.list())) dev.off()
    
    # å¯è§†åŒ–ç¼ºå¤±æ•°æ®
    aggr_plot <- aggr(data, 
                      col=c('navyblue','red'), 
                      numbers=TRUE, 
                      sortVars=TRUE,
                      labels=names(data), 
                      cex.axis=0.7,
                      gap=3, 
                      ylab=c("Missing data pattern","Pattern"))
    
    return(aggr_plot)
  }, error = function(e) {
    cat("å›¾å½¢æ˜¾ç¤ºå‡ºç°é—®é¢˜ï¼Œè·³è¿‡å¯è§†åŒ–æ­¥éª¤\n")
    cat("é”™è¯¯ä¿¡æ¯:", e$message, "\n")
    return(NULL)
  })
}

# å°è¯•ç”Ÿæˆç¼ºå¤±æ•°æ®å›¾
aggr_result <- plot_missing_data(check_data)

# ä¿®å¤ç‰ˆï¼šåˆ›å»ºç¼ºå¤±ç‡ç»Ÿè®¡è¡¨å‡½æ•°
create_missing_table <- function(data) {
  # è®¡ç®—æ€»æ ·æœ¬é‡
  total_n <- nrow(data)
  
  # ä½¿ç”¨æ›´ç®€å•çš„æ–¹æ³•è®¡ç®—ç¼ºå¤±æƒ…å†µ
  missing_stats <- data.frame(
    Variable = names(data),
    Number_of_missing = sapply(data, function(x) sum(is.na(x))),
    stringsAsFactors = FALSE
  )
  
  # è®¡ç®—ç¼ºå¤±ç™¾åˆ†æ¯”
  missing_stats$Percent_of_missing <- round((missing_stats$Number_of_missing / total_n) * 100, 2)
  
  # æŒ‰ç¼ºå¤±æ•°é‡é™åºæ’åˆ—
  missing_stats <- missing_stats[order(missing_stats$Number_of_missing, decreasing = TRUE), ]
  
  # é‡ç½®è¡Œå
  rownames(missing_stats) <- NULL
  
  return(missing_stats)
}

# ç”Ÿæˆç¼ºå¤±ç‡è¡¨
missing_table <- create_missing_table(check_data)

# æ˜¾ç¤ºå‰å‡ è¡Œæ•°æ®
cat("ç¼ºå¤±ç‡ç»Ÿè®¡ç»“æœï¼ˆå‰10è¡Œï¼‰ï¼š\n")
print(head(missing_table, 10))

# åˆ›å»ºåŒ…å«å˜é‡ç±»å‹çš„è¯¦ç»†è¡¨æ ¼
create_detailed_missing_table <- function(data) {
  # è·å–å˜é‡ç±»å‹
  var_types <- sapply(data, function(x) {
    if(is.numeric(x)) {
      return("Continuous")
    } else if(is.factor(x) || is.character(x)) {
      return("Categorical")
    } else {
      return("Other")
    }
  })
  
  # è®¡ç®—æ€»æ ·æœ¬é‡
  total_n <- nrow(data)
  
  # åˆ›å»ºè¯¦ç»†ç»Ÿè®¡è¡¨
  detailed_stats <- data.frame(
    Variable = names(data),
    Variable_Type = var_types,
    Number_of_missing = sapply(data, function(x) sum(is.na(x))),
    stringsAsFactors = FALSE
  )
  
  # è®¡ç®—ç¼ºå¤±ç™¾åˆ†æ¯”
  detailed_stats$Percent_of_missing <- round((detailed_stats$Number_of_missing / total_n) * 100, 2)
  
  # æŒ‰ç¼ºå¤±æ•°é‡é™åºæ’åˆ—
  detailed_stats <- detailed_stats[order(detailed_stats$Number_of_missing, decreasing = TRUE), ]
  
  # é‡ç½®è¡Œå
  rownames(detailed_stats) <- NULL
  
  return(detailed_stats)
}

# åˆ›å»ºä¸‰çº¿è¡¨æ ¼å¼å‡½æ•°
create_three_line_table <- function(missing_data, include_type = FALSE) {
  
  if(include_type) {
    # åŒ…å«å˜é‡ç±»å‹çš„ç‰ˆæœ¬
    ft <- flextable(missing_data) %>%
      set_header_labels(
        Variable = "Variable",
        Variable_Type = "Type", 
        Number_of_missing = "Number of missing",
        Percent_of_missing = "Percent of missing (%)"
      ) %>%
      width(j = 1, width = 2.0) %>%
      width(j = 2, width = 1.2) %>%
      width(j = 3, width = 1.5) %>%
      width(j = 4, width = 1.8) %>%
      align(align = "left", j = 1:2, part = "body") %>%
      align(align = "center", j = 3:4, part = "body")
  } else {
    # åŸºç¡€ç‰ˆæœ¬
    ft <- flextable(missing_data) %>%
      set_header_labels(
        Variable = "Variable",
        Number_of_missing = "Number of missing", 
        Percent_of_missing = "Percent of missing (%)"
      ) %>%
      width(j = 1, width = 2.5) %>%
      width(j = 2, width = 1.8) %>%
      width(j = 3, width = 2.0) %>%
      align(align = "left", j = 1, part = "body") %>%
      align(align = "center", j = 2:3, part = "body")
  }
  
  # é€šç”¨æ ¼å¼è®¾ç½®
  ft <- ft %>%
    # è®¾ç½®å­—ä½“å’Œå¤§å°
    font(fontname = "Times New Roman", part = "all") %>%
    fontsize(size = 11, part = "all") %>%
    # è®¾ç½®æ ‡é¢˜å¯¹é½
    align(align = "center", part = "header") %>%
    # æ·»åŠ ä¸‰çº¿è¡¨è¾¹æ¡†
    border_remove() %>%
    hline_top(border = fp_border(color = "black", width = 2), part = "header") %>%
    hline_bottom(border = fp_border(color = "black", width = 1), part = "header") %>%
    hline_bottom(border = fp_border(color = "black", width = 2), part = "body") %>%
    # è®¾ç½®è¡Œé«˜
    height_all(height = 0.3)
  
  return(ft)
}

# ä¿å­˜ä¸ºWordæ–‡æ¡£çš„å‡½æ•°
save_to_word <- function(table, filename = "missing_rate_table.docx", table_title = "Table S3: Missing rate for demographics and clinical variables extracted from the database during the observation period.") {
  tryCatch({
    # åˆ›å»ºWordæ–‡æ¡£
    doc <- read_docx()
    
    # æ·»åŠ è¡¨æ ¼æ ‡é¢˜
    doc <- doc %>%
      body_add_par(table_title, style = "Normal") %>%
      body_add_par("") %>%
      body_add_flextable(table) %>%
      body_add_par("") %>%
      body_add_par("Note: This table shows the missing data pattern for all variables included in the analysis.", 
                   style = "Normal")
    
    # ä¿å­˜æ–‡æ¡£
    print(doc, target = filename)
    cat("âœ“ è¡¨æ ¼å·²æˆåŠŸä¿å­˜ä¸º:", filename, "\n")
    
  }, error = function(e) {
    cat("âŒ ä¿å­˜Wordæ–‡æ¡£æ—¶å‡ºé”™:", e$message, "\n")
    cat("è¯·æ£€æŸ¥æ˜¯å¦å·²æ­£ç¡®å®‰è£…officeråŒ…\n")
    
    # å°è¯•ä¿å­˜ä¸ºHTMLæ ¼å¼ä½œä¸ºå¤‡é€‰
    tryCatch({
      html_filename <- gsub("\\.docx$", ".html", filename)
      save_as_html(table, html_filename)
    }, error = function(e2) {
      cat("HTMLä¿å­˜ä¹Ÿå¤±è´¥äº†\n")
    })
  })
}

# HTMLå¤‡é€‰ä¿å­˜å‡½æ•°
save_as_html <- function(table, filename) {
  html_content <- htmltools_value(table)
  writeLines(html_content, filename)
  cat("âœ“ å·²ä¿å­˜HTMLç‰ˆæœ¬:", filename, "\n")
}

# ç”ŸæˆåŸºç¡€ç‰ˆæœ¬è¡¨æ ¼
cat("\n=== æ­£åœ¨ç”ŸæˆåŸºç¡€ç‰ˆç¼ºå¤±ç‡è¡¨æ ¼ ===\n")
basic_table <- create_three_line_table(missing_table, include_type = FALSE)
print(basic_table)

# ç”Ÿæˆè¯¦ç»†ç‰ˆæœ¬è¡¨æ ¼
cat("\n=== æ­£åœ¨ç”Ÿæˆè¯¦ç»†ç‰ˆç¼ºå¤±ç‡è¡¨æ ¼ ===\n")
detailed_missing_table <- create_detailed_missing_table(check_data)
detailed_table <- create_three_line_table(detailed_missing_table, include_type = TRUE)
print(detailed_table)

# ä¿å­˜ä¸ºWordæ ¼å¼
cat("\n=== æ­£åœ¨ä¿å­˜Wordæ–‡æ¡£ ===\n")
save_to_word(basic_table, "missing_rate_table_basic.docx")
save_to_word(detailed_table, "missing_rate_table_detailed.docx")

# åˆ†æç»“æœæ€»ç»“
cat("\n", rep("=", 50), "\n", sep = "")
cat("         ç¼ºå¤±æ•°æ®åˆ†æç»“æœæ€»ç»“\n")
cat(rep("=", 50), "\n", sep = "")

total_vars <- ncol(check_data)
total_samples <- nrow(check_data)
high_missing_vars <- missing_table[missing_table$Percent_of_missing > 20, ]
zero_missing_vars <- missing_table[missing_table$Number_of_missing == 0, ]

cat("ğŸ“Š æ•°æ®åŸºæœ¬ä¿¡æ¯:\n")
cat("   æ€»æ ·æœ¬é‡:", total_samples, "\n")
cat("   æ€»å˜é‡æ•°:", total_vars, "\n")
cat("   å®Œå…¨æ— ç¼ºå¤±å˜é‡:", nrow(zero_missing_vars), "ä¸ª\n")

if(nrow(high_missing_vars) > 0) {
  cat("\nâš ï¸  ç¼ºå¤±ç‡è¶…è¿‡20%çš„å˜é‡ (", nrow(high_missing_vars), "ä¸ª):\n")
  for(i in 1:nrow(high_missing_vars)) {
    cat("   ", i, ".", high_missing_vars$Variable[i], 
        ": ", high_missing_vars$Percent_of_missing[i], "%\n")
  }
  cat("\nğŸ’¡ å»ºè®®: è€ƒè™‘æ˜¯å¦éœ€è¦ç§»é™¤è¿™äº›å˜é‡æˆ–è¿›è¡Œæ’è¡¥å¤„ç†\n")
} else {
  cat("\nâœ… æ‰€æœ‰å˜é‡çš„ç¼ºå¤±ç‡éƒ½åœ¨20%ä»¥ä¸‹\n")
}

# æ˜¾ç¤ºç¼ºå¤±ç‡åˆ†å¸ƒ
cat("\nğŸ“ˆ ç¼ºå¤±ç‡åˆ†å¸ƒ:\n")
missing_ranges <- cut(missing_table$Percent_of_missing, 
                      breaks = c(0, 5, 10, 15, 20, 100),
                      labels = c("0-5%", "5-10%", "10-15%", "15-20%", ">20%"),
                      include.lowest = TRUE)
missing_dist <- table(missing_ranges)
for(i in 1:length(missing_dist)) {
  cat("   ", names(missing_dist)[i], ":", missing_dist[i], "ä¸ªå˜é‡\n")
}

cat("\nğŸ“ ç”Ÿæˆçš„æ–‡ä»¶:\n")
cat("   1. missing_rate_table_basic.docx - åŸºç¡€ä¸‰çº¿è¡¨\n")
cat("   2. missing_rate_table_detailed.docx - åŒ…å«å˜é‡ç±»å‹çš„è¯¦ç»†è¡¨\n")

cat("\nâœ¨ ä»»åŠ¡å®Œæˆï¼\n")
```

## å› å­åŒ–åˆ†ç±»å˜é‡-\>missForest å‡†å¤‡

```{r}
# åŠ è½½å¿…è¦çš„åŒ…
if(!require(readxl)) install.packages("readxl")  # å¦‚æœå°šæœªå®‰è£…
library(readxl)

# 1. è¯»å–å˜é‡å…ƒæ•°æ®æ–‡ä»¶ï¼ˆæ–‡ä»¶åä¸ºfi_lab_metadata.xlsx"ï¼‰
# æ–‡ä»¶åº”åŒ…å«ä¸‰åˆ—ï¼šå˜é‡åã€å˜é‡ç±»å‹ã€åˆ†ç±»æ ‡å¿—
metadata <- read_excel("fi_lab_metadata.xlsx")

# æŸ¥çœ‹å…ƒæ•°æ®
print(metadata)


# 2. è¯†åˆ«éœ€è¦è½¬æ¢ä¸ºå› å­çš„åˆ†ç±»å˜é‡
# å…ƒæ•°æ®ä¸­æœ‰ä¸€ä¸ªåä¸º"flag"çš„åˆ—ï¼ŒåŒ…å«"Categorical"æˆ–"Continuous"
categorical_vars <- metadata$variable_name[metadata$flag == "Categorical"]

# æ£€æŸ¥æ‰¾åˆ°çš„åˆ†ç±»å˜é‡
cat("éœ€è¦è½¬æ¢ä¸ºå› å­çš„åˆ†ç±»å˜é‡:\n")
print(categorical_vars)

# 3. å°†è¿™äº›å˜é‡è½¬æ¢ä¸ºå› å­
# é¦–å…ˆç¡®ä¿è¿™äº›å˜é‡å­˜åœ¨äºæ•°æ®é›†ä¸­
existing_categorical_vars <- categorical_vars[categorical_vars %in% names(fi_lab)]

if(length(existing_categorical_vars) > 0) {
  fi_lab[existing_categorical_vars] <- lapply(fi_lab[existing_categorical_vars], as.factor)
  cat("\næˆåŠŸå°†ä»¥ä¸‹å˜é‡è½¬æ¢ä¸ºå› å­:\n")
  print(existing_categorical_vars)
} else {
  cat("\næœªæ‰¾åˆ°éœ€è¦è½¬æ¢çš„åˆ†ç±»å˜é‡ã€‚è¯·æ£€æŸ¥å…ƒæ•°æ®æ–‡ä»¶ä¸­çš„å˜é‡åæ˜¯å¦ä¸æ•°æ®é›†åŒ¹é…ã€‚\n")
}

# 4. éªŒè¯è½¬æ¢ç»“æœ
cat("\nè½¬æ¢åçš„å˜é‡ç±»å‹:\n")
print(sapply(fi_lab[existing_categorical_vars], class))

#åˆ é™¤æ—¥æœŸåˆ—ï¼Œè¿™äº›å˜é‡æ²¡æœ‰ç¼ºå¤±ï¼Œä½†æ˜¯ä¼šå½±å“missForestæ’è¡¥

exclude_vars <- metadata$variable_name[metadata$flag == "Date"]
fi_lab <- fi_lab %>% select(-any_of(exclude_vars))

str(fi_lab)

```

## ç”¨missForestè¿›è¡Œæ’è¡¥åŸºçº¿å˜é‡

#### ä½¿ç”¨missForeståŒ…è¿›è¡Œç¼ºå¤±æ•°æ®çš„æ’è¡¥ï¼Œå®ƒåŸºäºéšæœºæ£®æ—ç®—æ³•ï¼Œèƒ½æœ‰æ•ˆå¤„ç†æ··åˆç±»å‹æ•°æ®ã€‚

```{r}
# å®‰è£…å¹¶åŠ è½½å¿…è¦çš„åŒ…
if(!require(missForest)) install.packages("missForest")
if(!require(tidyverse)) install.packages("tidyverse")
library(missForest)
library(tidyverse)

# å¦‚æœimputed dataå­˜åœ¨ï¼Œåˆ™ä¸ç”¨å†run missForest,ä»¥å…è€—æ—¶
output_file <- "imputed_data.csv"  # ä½ ä¹‹å‰ä¿å­˜çš„CSVè·¯å¾„

# åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if (file.exists(output_file)) {
  # å­˜åœ¨ï¼šç›´æ¥è¯»å–æ’è¡¥å¥½çš„æ•°æ®
  imputed_data <- read_csv(output_file)  # æˆ– read.csv(output_file)
  print("æ’è¡¥æ•°æ®å·²å­˜åœ¨ï¼Œç›´æ¥è¯»å–å®Œæˆ")
} else {
  # ä¸å­˜åœ¨ï¼šè¿è¡Œ missForest æ’è¡¥å¹¶ä¿å­˜ç»“æœ
  print("å¼€å§‹è¿è¡Œ missForest æ’è¡¥...")
  # è½¬æ¢ä¸ºä¼ ç»Ÿdata.frameï¼ˆé€šå¸¸ä¸éœ€è¦,ä½†æ˜¯æ­¤å¤„missForestä¸workï¼‰
  fi_lab <- as.data.frame(fi_lab)
  # ä½¿ç”¨missForestè¿›è¡Œæ’è¡¥ï¼š 
  # default value for ntree is 100
  set.seed(123)  # è®¾ç½®éšæœºç§å­ä»¥ç¡®ä¿ç»“æœå¯å¤ç°
  imputed_data <- missForest(fi_lab, verbose = TRUE,maxiter = 20)

  # è·å–æ’è¡¥åçš„æ•°æ®é›†
  completed_data <- imputed_data$ximp
  
  # æŸ¥çœ‹æ’è¡¥è¯¯å·®
  print(imputed_data$OOBerror)

  # ä¿å­˜æ’è¡¥åçš„æ•°æ®
  write.csv(completed_data, "imputed_data.csv", row.names = FALSE)
}

```

# åˆå¹¶åŸºçº¿å˜é‡åˆ°tteæ•°æ®

```{r}
# è¯»å–æ•°æ®
imputed_data <- read.csv("imputed_data.csv")

# 2. è¯†åˆ«éœ€è¦è½¬æ¢ä¸ºå› å­çš„åˆ†ç±»å˜é‡
# å…ƒæ•°æ®ä¸­æœ‰ä¸€ä¸ªåä¸º"flag"çš„åˆ—ï¼ŒåŒ…å«"Categorical"æˆ–"Continuous"
categorical_vars <- metadata$variable_name[metadata$flag == "Categorical"]

# æ£€æŸ¥æ‰¾åˆ°çš„åˆ†ç±»å˜é‡
cat("éœ€è¦è½¬æ¢ä¸ºå› å­çš„åˆ†ç±»å˜é‡:\n")
print(categorical_vars)

# 3. å°†è¿™äº›å˜é‡è½¬æ¢ä¸ºå› å­
# é¦–å…ˆç¡®ä¿è¿™äº›å˜é‡å­˜åœ¨äºæ•°æ®é›†ä¸­
existing_categorical_vars <- categorical_vars[categorical_vars %in% names(fi_lab)]

if(length(existing_categorical_vars) > 0) {
  imputed_data[existing_categorical_vars] <- lapply(imputed_data[existing_categorical_vars], as.factor)
  cat("\næˆåŠŸå°†ä»¥ä¸‹å˜é‡è½¬æ¢ä¸ºå› å­:\n")
  print(existing_categorical_vars)
} else {
  cat("\næœªæ‰¾åˆ°éœ€è¦è½¬æ¢çš„åˆ†ç±»å˜é‡ã€‚è¯·æ£€æŸ¥å…ƒæ•°æ®æ–‡ä»¶ä¸­çš„å˜é‡åæ˜¯å¦ä¸æ•°æ®é›†åŒ¹é…ã€‚\n")
}
# åˆå¹¶åˆ°tte dataä¸­å»
tte<- tte %>%
      select(subject_id, stay_id, hadm_id, testcd, test, cnsr, aval) %>%
      left_join(imputed_data, 
                by = c("subject_id", "stay_id", "hadm_id")) 

 # ä¿å­˜åˆå¹¶åçš„æ•°æ®
  write.csv(tte, "tte.csv", row.names = FALSE)
```

# Table 1 Characteristics and outcomes of participants categorized by FI-Lab index

#### ä½¿ç”¨compareGroupsåŒ…ç”Ÿæˆæ ‡å‡†åŒ–çš„æè¿°æ€§ç»Ÿè®¡è¡¨ï¼Œå¹¶é€šè¿‡flextableå’Œofficerå¯¼å‡ºä¸ºWordæ ¼å¼ã€‚

```{r}
# å®‰è£…å’ŒåŠ è½½å¿…è¦çš„åŒ…
if(!require(compareGroups)) install.packages("compareGroups")
if(!require(flextable)) install.packages("flextable")
if(!require(officer)) install.packages("officer")
if(!require(dplyr)) install.packages("dplyr")
library(compareGroups)
library(flextable)
library(officer)
library(dplyr)

# å‡†å¤‡å…ƒæ•°æ®
metadata_tableone <- metadata %>%
  filter(tableone == "Y") %>%
  arrange(order) %>%
  mutate(
    label = ifelse(is.na(label) | label == "", variable_name, label)
  )

# å‡†å¤‡æ•°æ®
# å°†åˆ†ç±»å˜é‡è½¬ä¸ºå› å­
for (var in metadata_tableone$variable_name[metadata_tableone$flag == "Categorical"]) {
  imputed_data[[var]] <- factor(imputed_data[[var]])
}

# è®¾ç½®å˜é‡æ ‡ç­¾
for (i in 1:nrow(metadata_tableone)) {
  var_name <- metadata_tableone$variable_name[i]
  var_label <- metadata_tableone$label[i]
  attr(imputed_data[[var_name]], "label") <- var_label
}

# å®šä¹‰åˆ†ç»„å˜é‡ï¼ˆå¦‚æœéœ€è¦æŒ‰ç»„æ¯”è¾ƒï¼‰
group_var <- "level" 

# åˆ›å»ºcompareGroupså¯¹è±¡
cg <- compareGroups(
  as.formula(paste(group_var, "~ .")),
  data = imputed_data[, c(group_var, metadata_tableone$variable_name)],
  method = NA,  # è‡ªåŠ¨é€‰æ‹©æ–¹æ³•
  alpha = 0.05,  # æ˜¾è‘—æ€§æ°´å¹³
  include.label = TRUE  # åŒ…å«å˜é‡æ ‡ç­¾
)

# æå– hide = "0" çš„å˜é‡å
xx0 <- metadata$variable_name[metadata$hide0 == "1" & !is.na(metadata$hide0)]
xx0 <- as.character(xx0)
hide_list <- setNames(rep("0", length(xx0)), xx0)

# åˆ›å»ºè¡¨æ ¼å¯¹è±¡ (ä¿æŒæ‚¨åŸæœ‰è®¾ç½®)
table1 <- createTable(
  cg,
  show.all = TRUE,
  show.p.overall = TRUE,
  show.p.trend = FALSE,
  show.ratio = FALSE,
  hide.no = "no", hide = hide_list,
  digits = 2,
  digits.ratio = 2,
  sd.type = 2,
  q.type = c(1, 3)
)

# 1. ä½¿ç”¨compareGroupså¯¼å‡ºåˆ°CSV (å…¼å®¹ä¸­æ–‡)
export2csv(table1, file = "Table1_raw.csv")

# 2. è¯»å–CSVå¹¶è¿›è¡Œæ•°æ®æ¸…æ´—
custom_colnames <- c("variables", "Total", "Q1", "Q2", "Q3","Q4","P_value")
table_df <- read.csv("Table1_raw.csv", stringsAsFactors = FALSE, 
                     encoding = "UTF-8", col.names = custom_colnames) %>%
  mutate(
    variables = gsub(":.*$", "", variables),  # åˆ é™¤å†’å·
    variables = case_when(
      trimws(variables) == "0" ~ "    No",
      trimws(variables) == "1" ~ "    Yes",
      trimws(variables) == "F" ~ "    Female",
      trimws(variables) == "M" ~ "    Male",
      TRUE ~ variables  # ä¿ç•™å…¶ä»–ä¸å˜
    )
  )


ft <- table_df %>%
  flextable() %>%
  
  # ===== åŸºç¡€æ ¼å¼è®¾ç½® =====
theme_booktabs() %>%                      # ä¸“ä¸šä¸‰çº¿è¡¨æ ·å¼
  font(fontname = "Times New Roman", part = "all") %>%  # å­¦æœ¯å­—ä½“
  fontsize(size = 10, part = "all") %>%      # ç»Ÿä¸€å­—å·
  align(align = "center", part = "header") %>% # è¡¨å¤´å±…ä¸­
  align(j = 1, align = "left") %>%           # é¦–åˆ—å·¦å¯¹é½
  
  # ===== åˆ—å®½ä¼˜åŒ– =====
set_table_properties(layout = "autofit") %>% 
  width(j = 1, width = 2.5) %>%             # å˜é‡ååˆ—åŠ å®½
  hrule(rule = "exact")               # å›ºå®šè¡Œé«˜


# ä¿å­˜ä¸ºWordæ–‡æ¡£
save_as_docx(ft, 
             path = "Table 1.docx", 
             pr_section = prop_section(page_size = page_size(orient = "landscape")))






```

# Table 2 Baseline characteristics according to survivors and non-survivors groups

#### ä½¿ç”¨compareGroupsåŒ…ç”Ÿæˆæ ‡å‡†åŒ–çš„æè¿°æ€§ç»Ÿè®¡è¡¨ï¼Œå¹¶é€šè¿‡flextableå’Œofficerå¯¼å‡ºä¸ºWordæ ¼å¼ã€‚

```{r}
# å®‰è£…å’ŒåŠ è½½å¿…è¦çš„åŒ…
if(!require(compareGroups)) install.packages("compareGroups")
if(!require(flextable)) install.packages("flextable")
if(!require(officer)) install.packages("officer")
if(!require(dplyr)) install.packages("dplyr")
library(compareGroups)
library(flextable)
library(officer)
library(dplyr)

# å‡†å¤‡å…ƒæ•°æ®
metadata_tableone <- metadata %>%
  filter(table2 == "Y") %>%
  arrange(order) %>%
  mutate(
    label = ifelse(is.na(label) | label == "", variable_name, label)
  )

# å‡†å¤‡æ•°æ®
# å°†åˆ†ç±»å˜é‡è½¬ä¸ºå› å­
for (var in metadata_tableone$variable_name[metadata_tableone$flag == "Categorical"]) {
  imputed_data[[var]] <- factor(imputed_data[[var]])
}

# å•ç‹¬è®¾ç½®is_deadçš„å› å­æ°´å¹³ï¼ˆå…³é”®ä¿®æ”¹ï¼‰
if ("is_dead" %in% names(imputed_data)) {
  imputed_data$is_dead <- factor(
    imputed_data$is_dead,
    levels = c(0, 1),
    labels = c("Survivor", "Non-survivor")
  )
}

# è®¾ç½®å˜é‡æ ‡ç­¾
for (i in 1:nrow(metadata_tableone)) {
  var_name <- metadata_tableone$variable_name[i]
  var_label <- metadata_tableone$label[i]
  attr(imputed_data[[var_name]], "label") <- var_label
}

# å®šä¹‰åˆ†ç»„å˜é‡ï¼ˆä¿®æ”¹ä¸ºdeath_within_icu_28daysï¼‰
group_var <- "death_within_icu_28days"  # ä¿®æ”¹ç‚¹

# åˆ›å»ºcompareGroupså¯¹è±¡
cg <- compareGroups(
  as.formula(paste(group_var, "~ .")),
  data = imputed_data[, c(group_var, metadata_tableone$variable_name)],
  method = NA,  # è‡ªåŠ¨é€‰æ‹©æ–¹æ³•
  alpha = 0.05,  # æ˜¾è‘—æ€§æ°´å¹³
  include.label = TRUE  # åŒ…å«å˜é‡æ ‡ç­¾
)

# æå– hide = "0" çš„å˜é‡å
xx0 <- metadata$variable_name[metadata$hide0 == "1" & !is.na(metadata$hide0)]
xx0 <- as.character(xx0)
hide_list <- setNames(rep("0", length(xx0)), xx0)

# åˆ›å»ºè¡¨æ ¼å¯¹è±¡
table1 <- createTable(
  cg,
  show.all = TRUE,
  show.p.overall = TRUE,
  show.p.trend = FALSE,
  show.ratio = FALSE,
  hide.no = "no", hide = hide_list,
  digits = 2,
  digits.ratio = 2,
  sd.type = 2,
  q.type = c(1, 3)
)

# ä¿®æ”¹åˆ—åä»¥é€‚åº”æ–°åˆ†ç»„ï¼ˆå…³é”®ä¿®æ”¹ï¼‰
custom_colnames <- c("variables", "Total", "Survivor", "Non-survivor", "P_value")  # ä¿®æ”¹ç‚¹

# å¯¼å‡ºå’Œæ¸…æ´—æ•°æ®
export2csv(table1, file = "Table2_raw.csv")
table_df <- read.csv("Table2_raw.csv", stringsAsFactors = FALSE, 
                     encoding = "UTF-8", col.names = custom_colnames) %>%
  mutate(
    variables = gsub(":.*$", "", variables),  # åˆ é™¤å†’å·
    variables = case_when(
      trimws(variables) == "0" ~ "    No",
      trimws(variables) == "1" ~ "    Yes",
      trimws(variables) == "F" ~ "    Female",
      trimws(variables) == "M" ~ "    Male",
      TRUE ~ variables
    )
  )

# åˆ›å»ºflextable
ft <- table_df %>%
  flextable() %>%
  theme_booktabs() %>%
  font(fontname = "Times New Roman", part = "all") %>%
  fontsize(size = 10, part = "all") %>%
  align(align = "center", part = "header") %>%
  align(j = 1, align = "left") %>%
  set_table_properties(layout = "autofit") %>% 
  width(j = 1, width = 2.5) %>%
  hrule(rule = "exact")

# ä¿å­˜ä¸ºWordæ–‡æ¡£
save_as_docx(ft, 
             path = "Table 2.docx", 
             pr_section = prop_section(page_size = page_size(orient = "landscape")))
```

# Table 3 Cox proportional hazard models for 28-Day ICU and in-hospital mortality

## å…±çº¿æ€§è¯Šæ–­VIF

```{r}
# å®‰è£…å¹¶åŠ è½½å¿…è¦çš„åŒ…
if(!require(car)) install.packages("car")
if(!require(survival)) install.packages("survival")
if(!require(corrplot)) install.packages("corrplot")
library(car)
library(survival)
library(corrplot)
library(tidyverse)

# è¯»å–æ•°æ®
data <-tte %>% filter(testcd=="ICU28D") %>%
  select(-all_of(c("Q1","Q2","Q3","subject_id","stay_id","hadm_id","total_number","total_deficit", "flab")))

# é¦–å…ˆæ£€æŸ¥è‡ªå˜é‡ä¹‹é—´çš„ç›¸å…³æ€§
# æ³¨æ„ï¼šä»…é€‰æ‹©æ•°å€¼å‹å˜é‡è¿›è¡Œç›¸å…³æ€§åˆ†æ
numeric_vars <- names(data)[sapply(data, is.numeric)]
# ä»numeric_varsä¸­æ’é™¤æ—¶é—´å’Œäº‹ä»¶å˜é‡
time_event_vars <- c("aval", "cnsr")  # æ›¿æ¢ä¸ºæ‚¨çš„æ—¶é—´å’Œäº‹ä»¶å˜é‡å
numeric_vars <- setdiff(numeric_vars, time_event_vars)

# è®¡ç®—ç›¸å…³çŸ©é˜µ
if(length(numeric_vars) > 1) {
  cor_matrix <- cor(data[, numeric_vars], use = "pairwise.complete.obs")
  
  # å¯è§†åŒ–ç›¸å…³çŸ©é˜µ
  corrplot(cor_matrix, method = "circle", type = "upper", 
           tl.col = "black", tl.srt = 45,
           title = "è‡ªå˜é‡ç›¸å…³çŸ©é˜µ")
  
  # æ‰¾å‡ºé«˜åº¦ç›¸å…³çš„å˜é‡å¯¹ (|r| > 0.7)
  high_cor <- which(abs(cor_matrix) > 0.7 & abs(cor_matrix) < 1, arr.ind = TRUE)
  if(nrow(high_cor) > 0) {
    high_cor_pairs <- data.frame(
      Var1 = numeric_vars[high_cor[, 1]],
      Var2 = numeric_vars[high_cor[, 2]],
      Correlation = cor_matrix[high_cor]
    )
    print("é«˜åº¦ç›¸å…³çš„å˜é‡å¯¹ (|r| > 0.7):")
    print(high_cor_pairs)
  } else {
    print("æœªå‘ç°é«˜åº¦ç›¸å…³çš„å˜é‡å¯¹ (|r| > 0.7)")
  }
}

# å‡†å¤‡è¿›è¡ŒCoxæ¨¡å‹çš„å˜é‡, Model 2
predictor_vars <- metadata$variable_name[metadata$covars_m2 == 1]

# åˆ›å»ºCoxå›å½’çš„å…¬å¼
cox_formula <- as.formula(paste("Surv(aval, cnsr) ~", paste(predictor_vars, collapse = " + ")))

# å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œè®¡ç®—VIFå¹¶å¤„ç†é«˜VIFå˜é‡
check_and_handle_multicollinearity <- function(data, formula, threshold = 5) {
  # æå–é¢„æµ‹å˜é‡
  formula_terms <- terms(formula)
  predictors <- attr(formula_terms, "term.labels")
  
  # æ£€æŸ¥é¢„æµ‹å˜é‡æ˜¯å¦å­˜åœ¨
  missing_vars <- setdiff(predictors, names(data))
  if (length(missing_vars) > 0) {
    stop("ä»¥ä¸‹é¢„æµ‹å˜é‡åœ¨æ•°æ®ä¸­ä¸å­˜åœ¨: ", paste(missing_vars, collapse = ", "))
  }
  
  # åˆ›å»ºæ¨¡å‹æ•°æ®ï¼ˆä»…åŒ…å«é¢„æµ‹å˜é‡ï¼‰
  model_data <- data[, predictors, drop = FALSE]
  
  # æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆæ•°æ®
  if (nrow(model_data) == 0) {
    stop("æ¨¡å‹æ•°æ®ä¸ºç©ºï¼Œæ— æ³•è®¡ç®—VIF")
  }
  
  # å°†å­—ç¬¦å˜é‡è½¬æ¢ä¸ºå› å­
  cat_vars <- names(model_data)[sapply(model_data, function(x) is.character(x) | is.factor(x))]
  for (var in cat_vars) {
    model_data[[var]] <- as.factor(model_data[[var]])
  }
  
  # åˆ›å»ºä¼ªå› å˜é‡ï¼ˆVIFè®¡ç®—éœ€è¦ï¼‰
  model_data$pseudo_y <- rnorm(nrow(model_data))
  
  # å°è¯•æ‹Ÿåˆçº¿æ€§æ¨¡å‹
  lm_full <- tryCatch({
    lm_formula <- as.formula(paste("pseudo_y ~", paste(predictors, collapse = " + ")))
    lm(lm_formula, data = model_data)
  }, error = function(e) {
    cat("åˆ›å»ºå®Œæ•´çº¿æ€§æ¨¡å‹æ—¶å‡ºé”™:", e$message, "\n")
    cat("ä½¿ç”¨çš„é¢„æµ‹å˜é‡:", paste(predictors, collapse = ", "), "\n")
    cat("æ•°æ®é¢„è§ˆ:\n")
    print(head(model_data))
    return(NULL)
  })
  
  if (is.null(lm_full)) {
    stop("æ— æ³•åˆ›å»ºå®Œæ•´çº¿æ€§æ¨¡å‹è¿›è¡ŒVIFè®¡ç®—")
  }
  
  # è®¡ç®—VIF
  vif_results <- tryCatch({
    vif_matrix <- car::vif(lm_full)
    
    # å¤„ç†ä¸åŒç±»å‹çš„ç»“æœ
    if (is.matrix(vif_matrix)) {
      # æœ‰åˆ†ç±»å˜é‡çš„æƒ…å†µ
      vif_values <- sapply(rownames(vif_matrix), function(var) {
        if (var %in% cat_vars) {
          # åˆ†ç±»å˜é‡ï¼šGVIF^(1/(2*Df))
          vif_matrix[var, "GVIF"]^(1/(2*vif_matrix[var, "Df"]))
        } else {
          # è¿ç»­å˜é‡ï¼šç›´æ¥ä½¿ç”¨GVIF
          vif_matrix[var, "GVIF"]
        }
      })
    } else {
      # æ²¡æœ‰åˆ†ç±»å˜é‡çš„æƒ…å†µ
      vif_values <- vif_matrix
    }
    vif_values
  }, error = function(e) {
    cat("ä½¿ç”¨car::vifè®¡ç®—VIFæ—¶å‡ºé”™:", e$message, "\n")
    return(NULL)
  })
  
  if (is.null(vif_results)) {
    stop("VIFè®¡ç®—å¤±è´¥")
  }
  
  # åˆ›å»ºVIFæ•°æ®æ¡†
  vif_df <- data.frame(
    Variable = names(vif_results),
    VIF = as.numeric(vif_results)
  )
  vif_df <- vif_df[order(-vif_df$VIF), ]
  
  # è¾“å‡ºVIFå€¼
  cat("\n==== å˜é‡è†¨èƒ€å› å­ (VIF) å€¼ ====\n")
  print(vif_df)
  
  # å¯è§†åŒ–VIFå€¼ï¼ˆä»…å½“æœ‰ç»“æœæ—¶ï¼‰
  if (nrow(vif_df) > 0) {
    p <- ggplot(vif_df, aes(x = reorder(Variable, VIF), y = VIF)) +
      geom_bar(stat = "identity", fill = "#3498db") +
      geom_hline(yintercept = threshold, linetype = "dashed", color = "red") +
      coord_flip() +
      labs(title = "å˜é‡è†¨èƒ€å› å­ (VIF)",
           x = "å˜é‡",
           y = "VIFå€¼") +
      theme_minimal()
    print(p)
  } else {
    cat("æ²¡æœ‰å¯ç”¨çš„VIFå€¼è¿›è¡Œå¯è§†åŒ–\n")
  }
  
  # æ‰¾å‡ºé«˜VIFå˜é‡
  high_vif_vars <- vif_df$Variable[which(vif_df$VIF > threshold)]
  
  if (length(high_vif_vars) > 0) {
    cat("\nä»¥ä¸‹å˜é‡çš„VIFå€¼è¶…è¿‡", threshold, ":\n")
    print(high_vif_vars)
    return(list(high_vif = high_vif_vars, all_vif = vif_df))
  } else {
    cat("\næ‰€æœ‰å˜é‡çš„VIFå€¼å‡ä½äº", threshold, "ï¼Œæ— å…±çº¿æ€§é—®é¢˜ã€‚\n")
    return(list(high_vif = character(0), all_vif = vif_df))
  }
}
# æ‰§è¡Œå…±çº¿æ€§æ£€æŸ¥
multicollinearity_results <- check_and_handle_multicollinearity(data, cox_formula)

# å¤„ç†å…±çº¿æ€§é—®é¢˜
if (length(multicollinearity_results$high_vif) > 0) {
  cat("\nå¤„ç†å…±çº¿æ€§é—®é¢˜çš„æ–¹æ³•ï¼š\n")
  cat("1. ç§»é™¤é«˜åº¦å…±çº¿çš„å˜é‡\n")
  cat("2. åˆå¹¶ç›¸å…³å˜é‡ä¸ºæ–°å˜é‡\n")
  cat("3. ä½¿ç”¨æ­£åˆ™åŒ–æ–¹æ³•ï¼Œå¦‚ridgeå›å½’æˆ–lassoå›å½’\n")
  cat("4. ä½¿ç”¨ä¸»æˆåˆ†åˆ†æ(PCA)é™ç»´\n\n")
  
  # ç¤ºä¾‹ï¼šç§»é™¤VIFæœ€é«˜çš„å˜é‡
  vars_to_remove <- multicollinearity_results$high_vif[1]  # ç§»é™¤VIFæœ€é«˜çš„å˜é‡
  cat("ç¤ºä¾‹æ–¹æ³•1: ç§»é™¤å˜é‡:", vars_to_remove, "\n")
  
  # æ›´æ–°é¢„æµ‹å˜é‡åˆ—è¡¨
  predictor_vars_updated <- predictor_vars[!predictor_vars %in% vars_to_remove]
  
  # æ›´æ–°å…¬å¼
  cox_formula_updated <- as.formula(paste("Surv(time, event) ~", paste(predictor_vars_updated, collapse = " + ")))
  
  # é‡æ–°æ£€æŸ¥å…±çº¿æ€§
  cat("\nç§»é™¤", vars_to_remove, "åé‡æ–°æ£€æŸ¥å…±çº¿æ€§ï¼š\n")
  multicollinearity_results_updated <- check_and_handle_multicollinearity(data, cox_formula_updated)
  
  # æ›´æ–°Coxå…¬å¼ç”¨äºåç»­åˆ†æ
  cox_formula <- cox_formula_updated
  predictor_vars <- predictor_vars_updated
}
```

## PHå‡å®šæ£€éªŒ

```{r}
# å®‰è£…å¹¶åŠ è½½å¿…è¦çš„åŒ…
if(!require(survival)) install.packages("survival")
if(!require(survminer)) install.packages("survminer")
if(!require(dplyr)) install.packages("dplyr")
if(!require(flextable)) install.packages("flextable")
library(survival)
library(survminer)
library(dplyr)
library(flextable)
library(officer)
# è¯»å–æ•°æ®ï¼ˆç¡®ä¿å·²ç»å¤„ç†äº†å…±çº¿æ€§é—®é¢˜ï¼‰
# è¯»å–æ•°æ®testcd==ICU28D, HOSPXXD
data <-tte %>% filter(testcd=="HOSPXXD") %>%
  select(-all_of(c("Q1","Q2","Q3","subject_id","stay_id","hadm_id","total_number","total_deficit", "flab")))

# å‡†å¤‡è¿›è¡ŒCoxæ¨¡å‹çš„å˜é‡, Model 2
predictor_vars <- metadata$variable_name[metadata$covars_m2 == 1]

# åˆ›å»ºCoxå›å½’çš„å…¬å¼
cox_formula <- as.formula(paste("Surv(aval, cnsr) ~", paste(predictor_vars, collapse = " + ")))

# æ‹ŸåˆCoxæ¨¡å‹
cox_model <- coxph(cox_formula, data = data)

# --------------------------------
#  æ£€æŸ¥æ¯”ä¾‹é£é™©å‡å®š
# --------------------------------

ph_test <- cox.zph(cox_model)
# print(ph_test)

# è‡ªåŠ¨åŒ–ç”Ÿæˆæ£€éªŒæŠ¥å‘Š
valid_vars <- rownames(ph_test$table)[rownames(ph_test$table) != "GLOBAL"]
ph_report <- data.frame(
  Variable = c(valid_vars, "GLOBAL"),
  Chisq = ph_test$table[, "chisq"],
  df = ph_test$table[, "df"],
  p_value = ph_test$table[, "p"],
  Significance = ifelse(ph_test$table[, "p"] < 0.05, "Violation", "Pass")
)

print(ph_report)

ft <- flextable(ph_report) %>%
  set_header_labels(
    chisq = "Ï‡Â²", 
    df = "df",
    p = "p-value"
  ) %>%
  bg(part = "header", bg = "#1F4E79") %>%
  set_table_properties(layout = "autofit") %>%
  color(part = "header", color = "white")

# ä¿å­˜ä¸ºWord/HTMLæ ¼å¼
save_as_docx(ft, path = "PH_Test_Results.docx")

# # åŸå§‹å¯è§†åŒ–Schoenfeldæ®‹å·®
# par(mfrow = c(2, 2))  # è®¾ç½®2x2ç½‘æ ¼ä»¥æ˜¾ç¤ºå¤šä¸ªå›¾
# for (i in 1:length(ph_test$table[, 1])) {
#   plot(ph_test, var = i, main = paste("Schoenfeld Residuals for", names(ph_test$table[, 1])[i]))
#   abline(h = 0, col = "red", lty = 2)
# }
# par(mfrow = c(1, 1))  # é‡ç½®ä¸ºå•ä¸ªå›¾
# 
# # ä½¿ç”¨survmineråŒ…æä¾›çš„æ›´ç¾è§‚çš„å›¾å½¢
# ä½†æ˜¯å¾—åˆ°è­¦å‘Šä¿¡æ¯:
#   In regularize.values(x, y, ties, missing(ties), na.rm = na.rm) :
#   æŠ˜æ‹¢'x'æˆç›¸äº’ä¸åŒçš„å€¼
# ggcoxzph(ph_test,ties = "ordered")

# --------------------------------
#  æ”¹ç”¨ggplotç»˜å›¾å¹¶ä¿å­˜ä¸ºçŸ¢é‡å›¾å½¢
# --------------------------------
valid_vars <- setdiff(rownames(ph_test$table), "GLOBAL")

# åˆ›å»ºå›¾å½¢åˆ—è¡¨ï¼ˆéggcoxzphå¯¹è±¡ï¼‰
plot_list <- lapply(valid_vars, function(var) {
  
  # æå–æ®‹å·®æ•°æ®
  resid_data <- data.frame(
    time = ph_test$time,
    resid = ph_test$y[, var],
    smooth = lowess(ph_test$time, ph_test$y[, var])$y
  )
  
  # æ„å»ºè‡ªå®šä¹‰ggplotå¯¹è±¡
  ggplot(resid_data, aes(x = time)) +
    geom_point(aes(y = resid), alpha = 0.6, size = 2) +
    geom_line(aes(y = smooth), color = "red", linewidth = 1) +
    geom_hline(yintercept = 0, linetype = "dashed") +
    labs(
      title = paste("Schoenfeld Residuals:", var),
      subtitle = sprintf("Ï‡Â² = %.2f (df=%d, p=%s)", 
                         ph_test$table[var, "chisq"],
                         ph_test$table[var, "df"],
                         ifelse(ph_test$table[var, "p"] < 0.001, 
                                "<0.001", 
                                sprintf("%.3f", ph_test$table[var, "p"]))),
      x = "Time", 
      y = "Scaled Schoenfeld Residuals"
    ) +
    theme_minimal() +
    theme(
      plot.title = element_text(face = "bold", size = 14),
      plot.subtitle = element_text(size = 11)
    )
})

# æ–¹æ³•Aï¼šä½¿ç”¨ggpubrï¼ˆæ¨èï¼‰
ph_grid <- ggpubr::ggarrange(plotlist = plot_list, 
                             ncol = 2, nrow = ceiling(length(valid_vars)/2))

# æ–¹æ³•Bï¼šä½¿ç”¨gridExtraï¼ˆæ›¿ä»£æ–¹æ¡ˆï¼‰
# ph_grid <- gridExtra::grid.arrange(grobs = plot_list, ncol = 2)

# --------------------------------
#  å®‰å…¨ä¿å­˜å›¾å½¢
# --------------------------------
ggsave("PH_Validation_Grid.svg", ph_grid,
       width = 25, 
       height = 10 * ceiling(length(valid_vars)/2),
       units = "cm", dpi = 600)

print(ph_grid)

# --------------------------------
#  æ£€æŸ¥å…¨å±€æµ‹è¯•ç»“æœ
# --------------------------------

if (ph_test$table["GLOBAL", "p"] < 0.05) {
  cat("\nå…¨å±€æµ‹è¯•æ˜¾ç¤ºæ¯”ä¾‹é£é™©å‡å®šä¸æˆç«‹ (p =", ph_test$table["GLOBAL", "p"], ")\n")
  
  # è¯†åˆ«è¿åPHå‡å®šçš„å˜é‡
  non_ph_vars <- names(ph_test$table[, "p"])[ph_test$table[, "p"] < 0.05]
  non_ph_vars <- non_ph_vars[non_ph_vars != "GLOBAL"]
  
  if (length(non_ph_vars) > 0) {
    cat("ä»¥ä¸‹å˜é‡è¿åäº†æ¯”ä¾‹é£é™©å‡å®šï¼š\n")
    print(non_ph_vars)
    
    cat("\nå¤„ç†è¿åPHå‡å®šçš„æ–¹æ³•ï¼š\n")
    cat("1. åˆ†å±‚Coxæ¨¡å‹\n")
    cat("2. ä½¿ç”¨æ—¶é—´ä¾èµ–å‹åå˜é‡\n")
    cat("3. ä½¿ç”¨æ‰©å±•Coxæ¨¡å‹\n")
    cat("4. è€ƒè™‘ä½¿ç”¨å…¶ä»–ç”Ÿå­˜åˆ†ææ¨¡å‹ï¼Œå¦‚AFTæ¨¡å‹\n\n")
    
    # ç¤ºä¾‹ï¼šåˆ†å±‚Coxæ¨¡å‹
    if (length(non_ph_vars) == 1 && non_ph_vars %in% categorical_vars) {
      cat("ç¤ºä¾‹æ–¹æ³•1ï¼šå¯¹å˜é‡", non_ph_vars, "è¿›è¡Œåˆ†å±‚\n")
      
      # åˆ›å»ºåˆ†å±‚å…¬å¼
      strata_var <- non_ph_vars
      other_vars <- predictor_vars[!predictor_vars %in% strata_var]
      
      # ä½¿ç”¨strata()å‡½æ•°åˆ›å»ºåˆ†å±‚Coxæ¨¡å‹
      strata_formula <- as.formula(
        paste("Surv(time, event) ~", 
              paste(other_vars, collapse = " + "), 
              "+ strata(", strata_var, ")")
      )
      
      # æ‹Ÿåˆåˆ†å±‚Coxæ¨¡å‹
      stratified_cox_model <- coxph(strata_formula, data = data)
      print(summary(stratified_cox_model))
      
      # æ£€æŸ¥åˆ†å±‚åçš„PHå‡å®š
      ph_test_stratified <- cox.zph(stratified_cox_model)
      print(ph_test_stratified)
      
      # å¯è§†åŒ–æ®‹å·®
      ggcoxzph(ph_test_stratified)
      
      # æ›´æ–°Coxæ¨¡å‹ä¸ºåˆ†å±‚æ¨¡å‹
      cox_model <- stratified_cox_model
    } 
    
    # ç¤ºä¾‹ï¼šæ—¶é—´ä¾èµ–å‹åå˜é‡
    else {
      cat("ç¤ºä¾‹æ–¹æ³•2ï¼šå°†", non_ph_vars[1], "ä½œä¸ºæ—¶é—´ä¾èµ–å‹åå˜é‡\n")
      
      # åˆ›å»ºå¸¦æœ‰æ—¶é—´äº¤äº’é¡¹çš„å…¬å¼
      tt_var <- non_ph_vars[1]
      other_vars <- predictor_vars[!predictor_vars %in% tt_var]
      
      tt_formula <- as.formula(
        paste("Surv(time, event) ~", 
              paste(other_vars, collapse = " + "), 
              "+", tt_var,
              "+ tt(", tt_var, ")")
      )
      
      # æ‹Ÿåˆå¸¦æ—¶é—´ä¾èµ–å‹åå˜é‡çš„Coxæ¨¡å‹
      tt_cox_model <- coxph(tt_formula, data = data)
      print(summary(tt_cox_model))
      
      # æ›´æ–°Coxæ¨¡å‹
      cox_model <- tt_cox_model
    }
  }
} else {
  cat("\nå…¨å±€æµ‹è¯•æ˜¾ç¤ºæ¯”ä¾‹é£é™©å‡å®šæˆç«‹ (p =", ph_test$table["GLOBAL", "p"], ")\n")
  
  # ä»ç„¶æ£€æŸ¥æ˜¯å¦æœ‰å•ä¸ªå˜é‡ä¸æ»¡è¶³PHå‡å®š
  non_ph_vars <- names(ph_test$table[, "p"])[ph_test$table[, "p"] < 0.05]
  non_ph_vars <- non_ph_vars[non_ph_vars != "GLOBAL"]
  
  if (length(non_ph_vars) > 0) {
    cat("ä½†ä»¥ä¸‹ä¸ªåˆ«å˜é‡å¯èƒ½è¿åäº†æ¯”ä¾‹é£é™©å‡å®šï¼š\n")
    print(non_ph_vars)
    cat("å»ºè®®æ£€æŸ¥è¿™äº›å˜é‡çš„Schoenfeldæ®‹å·®å›¾å¹¶è€ƒè™‘å¤„ç†æ–¹æ³•\n")
  }
}
```

## **Coxæ¯”ä¾‹é£é™©æ¨¡å‹ï¼ˆHR, P for Trendï¼‰**

#### ä½¿ç”¨survivalåŒ…è¿›è¡ŒCoxæ¯”ä¾‹é£é™©å›å½’åˆ†æï¼Œè®¡ç®—é£é™©æ¯”å’ŒP for trendï¼Œå¹¶é€šè¿‡flextableå’Œofficerå¯¼å‡ºä¸ºWordæ ¼å¼ã€‚

```{r}
# å®‰è£…å’ŒåŠ è½½å¿…è¦çš„åŒ…
if(!require(survival)) install.packages("survival")
if(!require(survminer)) install.packages("survminer")
if(!require(flextable)) install.packages("flextable")
if(!require(officer)) install.packages("officer")
if(!require(broom)) install.packages("broom")
if(!require(dplyr)) install.packages("dplyr")
library(survival)
library(survminer)
library(flextable)
library(officer)
library(broom)
library(dplyr)

# å…¨å±€På€¼æ ¼å¼åŒ–å‡½æ•°
format_p_value <- function(p) {
  if(is.na(p)) return(NA_character_)
  if(p < 0.001) "<â€‰0.001" else sprintf("%.3f", p)
}

# é‡æ–°å®šä¹‰æå–å‡½æ•°
extract_cox_results <- function(cox_model, is_continuous = FALSE) {
  if(is.null(cox_model)) {
    if(is_continuous) {
      return(data.frame(
        Exposure = "Continuous variable per 0.01 unit",
        HR_CI = NA_character_,
        P_Value = NA_character_
      ))
    } else {
      return(data.frame(
        Exposure = c("Q1", "Q2", "Q3", "Q4"),
        HR_CI = c("Ref", NA_character_, NA_character_, NA_character_),
        P_Value = c(NA_character_, NA_character_, NA_character_, NA_character_)
      ))
    }
  }
  
  # æå–ç³»æ•°å’Œç½®ä¿¡åŒºé—´
  coefs <- exp(coef(cox_model))
  conf_int <- exp(confint(cox_model))
  
  if(is_continuous) {
    hr_ci <- sprintf("%.2f (%.2f, %.2f)", 
                     coefs[1], conf_int[1, 1], conf_int[1, 2])
    p_value <- summary(cox_model)$coefficients[1, "Pr(>|z|)"]
    
    data.frame(
      Exposure = "Continuous variable per 0.01 unit",
      HR_CI = hr_ci,
      P_Value = format_p_value(p_value)
    )
  } else {
    hr_ci <- rep(NA_character_, 4)
    p_values <- rep(NA_character_, 4)
    
    hr_ci[1] <- "Ref"
    
    n_coefs <- length(coefs)
    if(n_coefs > 0) {
      for(i in 1:min(n_coefs, 3)) {
        hr_ci[i+1] <- sprintf("%.2f (%.2f, %.2f)", 
                              coefs[i], conf_int[i, 1], conf_int[i, 2])
        p_values[i+1] <- format_p_value(summary(cox_model)$coefficients[i, "Pr(>|z|)"])
      }
    }
    
    data.frame(
      Exposure = c("Q1", "Q2", "Q3", "Q4"),
      HR_CI = hr_ci,
      P_Value = p_values
    )
  }
}

# ä¸»åˆ†ææµç¨‹
analyze_cox_models <- function() {
  
  # å®šä¹‰éœ€è¦åˆ†æçš„å¤šä¸ªæ—¶é—´ç‚¹
  testcd_list <- c( "ICU28D","HOSPXXD")
  
  # åˆ›å»ºç©ºç»“æœè¡¨
  results_table <- data.frame(
    Exposure = character(),
    Crude_HR_CI = character(),
    Crude_P = character(),
    Model1_HR_CI = character(),
    Model1_P = character(),
    Model2_HR_CI = character(),
    Model2_P = character(),
    stringsAsFactors = FALSE
  )
  
  # éå†æ¯ä¸ªæ—¶é—´ç‚¹æ•°æ®é›†
  for (testcd in testcd_list) {
    # é€‰æ‹©æ•°æ®å¹¶åˆå¹¶ - ä¿®å¤å…³é”®é”™è¯¯
    tte_selected <- tte %>%
      mutate(leveln=as.numeric(leveln))%>% #æ³¨æ„è¿™ä¸ªå˜é‡éœ€è¦ä¸ºæ•°å€¼è¿ç»­å‹ï¼Œå¯èƒ½å‰é¢å› å­åŒ–å½±å“åˆ°äº†
      filter(testcd == !!testcd)  # ä½¿ç”¨!!å–æ¶ˆå¼•ç”¨
    
    # å¦‚æœæ•°æ®é›†ä¸ºç©ºï¼Œè·³è¿‡å½“å‰æ—¶é—´ç‚¹
    if(nrow(tte_selected) == 0) {
      warning(paste("No data available for testcd:", testcd))
      next
    }
  
    # è®¾ç½®åå˜é‡
    covariates_m1 <- metadata$variable_name[metadata$covars_m1 == 1]
    covariates_m2 <- metadata$variable_name[metadata$covars_m2 == 1]
    
    
    # 1. è¿ç»­å˜é‡æ¨¡å‹ ----
    cox_crude_cont <- tryCatch({
      coxph(Surv(aval, cnsr) ~ flab100, data = tte_selected)
    }, error = function(e) NULL)
    
    cox_m1_cont <- tryCatch({
      if(length(covariates_m1) > 0) {
        cox_formula <- as.formula(paste("Surv(aval, cnsr) ~ flab100 +", 
                                        paste(covariates_m1, collapse = "+")))
      } else {
        cox_formula <- as.formula("Surv(aval, cnsr) ~ flab100")
      }
      coxph(cox_formula, data = tte_selected)
    }, error = function(e) NULL)
    
    cox_m2_cont <- tryCatch({
      if(length(covariates_m2) > 0) {
        cox_formula <- as.formula(paste("Surv(aval, cnsr) ~ flab100 +", 
                                        paste(covariates_m2, collapse = "+")))
      } else {
        cox_formula <- as.formula("Surv(aval, cnsr) ~ flab100")
      }
      coxph(cox_formula, data = tte_selected)
    }, error = function(e) NULL)
    
    # 2. åˆ†ç±»å˜é‡æ¨¡å‹ ----
    cox_crude_cat <- tryCatch({
      coxph(Surv(aval, cnsr) ~ level, data = tte_selected)
    }, error = function(e) NULL)
    
    cox_m1_cat <- tryCatch({
      if(length(covariates_m1) > 0) {
        cox_formula <- as.formula(paste("Surv(aval, cnsr) ~ level +", 
                                        paste(covariates_m1, collapse = "+")))
      } else {
        cox_formula <- as.formula("Surv(aval, cnsr) ~ level")
      }
      coxph(cox_formula, data = tte_selected)
    }, error = function(e) NULL)
    
    cox_m2_cat <- tryCatch({
      if(length(covariates_m2) > 0) {
        cox_formula <- as.formula(paste("Surv(aval, cnsr) ~ level +", 
                                        paste(covariates_m2, collapse = "+")))
      } else {
        cox_formula <- as.formula("Surv(aval, cnsr) ~ level")
      }
      coxph(cox_formula, data = tte_selected)
    }, error = function(e) NULL)
    
    # 3. è¶‹åŠ¿æ£€éªŒ ----
    p_trend0 <- tryCatch({
      cox_trend <- coxph(Surv(aval, cnsr) ~ leveln, data = tte_selected)
      summary(cox_trend)$coefficients["leveln", "Pr(>|z|)"]
    }, error = function(e) NA)
    
    p_trend1 <- tryCatch({
      if(length(covariates_m1) > 0) {
        trend_formula <- as.formula(paste("Surv(aval, cnsr) ~ leveln +", 
                                          paste(covariates_m1, collapse = "+")))
      } else {
        trend_formula <- as.formula("Surv(aval, cnsr) ~ leveln")
      }
      cox_trend <- coxph(trend_formula, data = tte_selected)
      summary(cox_trend)$coefficients["leveln", "Pr(>|z|)"]
    }, error = function(e) NA)
    
    p_trend2 <- tryCatch({
      if(length(covariates_m2) > 0) {
        trend_formula <- as.formula(paste("Surv(aval, cnsr) ~ leveln +", 
                                          paste(covariates_m2, collapse = "+")))
      } else {
        trend_formula <- as.formula("Surv(aval, cnsr) ~ leveln")
      }
      cox_trend <- coxph(trend_formula, data = tte_selected)
      summary(cox_trend)$coefficients["leveln", "Pr(>|z|)"]
    }, error = function(e) NA)
    
    # æå–æ‰€æœ‰ç»“æœ
    cont_crude <- extract_cox_results(cox_crude_cont, TRUE)
    cont_m1 <- extract_cox_results(cox_m1_cont, TRUE)
    cont_m2 <- extract_cox_results(cox_m2_cont, TRUE)
    
    cat_crude <- extract_cox_results(cox_crude_cat)
    cat_m1 <- extract_cox_results(cox_m1_cat)
    cat_m2 <- extract_cox_results(cox_m2_cat)
    
    # åˆ›å»ºå½“å‰æ—¶é—´ç‚¹çš„ç»“æœè¡¨
    current_results <- data.frame(
      Exposure = c(cont_crude$Exposure, cat_crude$Exposure),
      Crude_HR_CI = c(cont_crude$HR_CI, cat_crude$HR_CI),
      Crude_P = c(cont_crude$P_Value, cat_crude$P_Value),
      Model1_HR_CI = c(cont_m1$HR_CI, cat_m1$HR_CI),
      Model1_P = c(cont_m1$P_Value, cat_m1$P_Value),
      Model2_HR_CI = c(cont_m2$HR_CI, cat_m2$HR_CI),
      Model2_P = c(cont_m2$P_Value, cat_m2$P_Value)
    )
    
    # æ·»åŠ è¶‹åŠ¿æ£€éªŒè¡Œ
    trend_results <- data.frame(
      Exposure = "P for trend",
      Crude_HR_CI = NA_character_,
      Crude_P = format_p_value(p_trend0),
      Model1_HR_CI = NA_character_,
      Model1_P = format_p_value(p_trend1),
      Model2_HR_CI = NA_character_,
      Model2_P = format_p_value(p_trend2)
    )
    
    current_results <- rbind(current_results, trend_results)
    
    # æ·»åŠ è‡ªå®šä¹‰æ ‡é¢˜è¡Œ
    title_text <- ifelse(grepl("^HOSP", testcd),
                         "In-hospital mortality",
                         paste0(gsub("ICU([0-9]+)D", "\\1", testcd), 
                                "-day all-cause mortality"))
    
    title_row <- data.frame(
      Exposure = title_text,
      Crude_HR_CI = "Crude model",
      Crude_P = "",
      Model1_HR_CI = "Model 1",
      Model1_P = "",
      Model2_HR_CI = "Model 2",
      Model2_P = ""
    )
    
    # æ·»åŠ åˆ°æ€»ç»“æœè¡¨
    results_table <- rbind(
      results_table,
      title_row,
      current_results,
      data.frame(Exposure = "", 
                 Crude_HR_CI = "",
                 Crude_P = "",
                 Model1_HR_CI = "",
                 Model1_P = "",
                 Model2_HR_CI = "",
                 Model2_P = "")
    )
  }
  
  return(results_table)
}

# æ‰§è¡Œåˆ†æ
results_table <- analyze_cox_models()

# åˆ›å»ºå¹¶æ ¼å¼åŒ–è¡¨æ ¼
create_cox_table <- function(results) {
  # ç§»é™¤æœ€åçš„ç©ºè¡Œ
  results <- results[results$Exposure != "", ]
  
  ft <- flextable(results) %>%
    # è®¾ç½®è¡¨æ ¼æ ‡é¢˜
    set_caption(caption = "Table 3 Cox proportional hazard models for in-hospital and 28-Day ICU mortality", style = "Table Caption") %>% 
    # 2025/06/14 ä¹‹å‰å¯ä»¥è¿è¡Œï¼Œè¿™æ¬¡è¿è¡Œå¤±è´¥
    #font(fontname = "Times New Roman", part = "all") %>%  # å­¦æœ¯å­—ä½“
    # åŸºæœ¬æ ·å¼
    theme_booktabs() %>%
    #2025/06/14 ä¹‹å‰å¯ä»¥è¿è¡Œï¼Œè¿™æ¬¡è¿è¡Œå¤±è´¥
    #font(fontname = "Times New Roman", part = "all") %>%  # å­¦æœ¯å­—ä½“
    fontsize(size = 10, part = "all") %>%      # ç»Ÿä¸€å­—å·
    align(align = "center", part = "all") %>%
    align(j = 1, align = "left") %>%
    set_table_properties(layout = "autofit") %>%
    # è®¾ç½®åˆ—å
    set_header_labels(
      Exposure = "Exposure",
      Crude_HR_CI = "HR (95% CI)",
      Crude_P = "P-value",
      Model1_HR_CI = "HR (95% CI)",
      Model1_P = "P-value",
      Model2_HR_CI = "HR (95% CI)",
      Model2_P = "P-value"
    ) %>%
    # æ·»åŠ æ¨¡å‹åç§°è¡Œ
    add_header_row(values = c("", "Crude Model", "Model 1", "Model 2"),
                   colwidths = c(1, 2, 2, 2)) %>%
    # è®¾ç½®é¡µçœ‰æ ¼å¼
    bold(part = "header") %>%
    
    # è‡ªåŠ¨è°ƒæ•´åˆ—å®½
    autofit()
  
  # æ ‡è¯†æ ‡é¢˜è¡Œå’Œè¶‹åŠ¿è¡Œ
  title_rows <- which(grepl("mortality", results$Exposure))
  trend_rows <- which(results$Exposure == "P for trend")
  
  # é€ä¸ªå¤„ç†æ ‡é¢˜è¡Œåˆå¹¶
  for (row in title_rows) {
    ft <- merge_at(ft, i = row, j = 1:7)
  }
  
  # è®¾ç½®æ ¼å¼
  ft <- ft %>%
    
    bold(i = title_rows) %>%
    italic(i = trend_rows) %>%
    bold(i = trend_rows)
  
  return(ft)
}

# åˆ›å»ºè¡¨æ ¼
cox_table <- create_cox_table(results_table)

# ä¿å­˜ä¸ºWordæ–‡æ¡£
save_as_docx(cox_table, 
             path = "Table 3.docx", 
             pr_section = prop_section(page_size = page_size(orient = "landscape")))

# æ˜¾ç¤ºè¡¨æ ¼
cox_table

```

## **Kaplan-Meierç”Ÿå­˜æ›²çº¿ï¼ˆjpgã€svgã€tifæ ¼å¼ï¼‰**

#### ä½¿ç”¨survivalå’ŒsurvmineråŒ…åˆ›å»ºé«˜è´¨é‡çš„Kaplan-Meierç”Ÿå­˜æ›²çº¿ï¼Œå¹¶ä»¥å¤šç§æ ¼å¼ä¿å­˜ã€‚

```{r}
# åŠ è½½å¿…è¦åŒ…
library(survival)
library(survminer)
library(ggplot2)
library(dplyr)
library(stringr)
library(gridExtra)

# å®šä¹‰ç»˜å›¾å‡½æ•°ï¼ˆè§£å†³æ‰€æœ‰é—®é¢˜ï¼‰
generate_km_plots <- function(tte_data, testcd) {
  local_data <- as.data.frame(tte_data)
  # æ•°æ®å‡†å¤‡ï¼ˆä½¿ç”¨å°å†™levelï¼‰
  plot_data <- local_data %>%
    filter(testcd == !!testcd) %>%
    mutate(level = factor(level, levels = c("Q1", "Q2", "Q3", "Q4")))  # å˜é‡åæ”¹ä¸ºå°å†™
  # æ£€æŸ¥æ•°æ®
  if(nrow(plot_data) == 0) {
    stop(paste("æ²¡æœ‰æ‰¾åˆ°", testcd, "çš„æ•°æ®"))
  }
  # åˆ›å»ºç”Ÿå­˜å¯¹è±¡
  surv_obj <- Surv(time = plot_data$aval, event = plot_data$cnsr)
  
  # æ™ºèƒ½æ ‡é¢˜ç”Ÿæˆ
  title <- ifelse(str_detect(testcd, "HOSP"), "In-hospital mortality",
                  ifelse(str_detect(testcd, "ICU"), 
                         paste0(str_extract(testcd, "\\d+"), "-day all-cause mortality"),
                         paste(testcd, "Mortality")))
  km_fit <- with(plot_data, survfit(Surv(aval, cnsr) ~ level))
  # æ‹ŸåˆKMæ¨¡å‹
  # km_fit <- survfit(surv_obj ~ level, data = plot_data)  # ä½¿ç”¨levelåˆ†ç»„
  
  # è®¡ç®—log-rankæ£€éªŒpå€¼
  # pval <- surv_pvalue(km_fit)$pval
  surv_diff <- survdiff(Surv(aval, cnsr) ~ level, data = plot_data)
  pval <- surv_diff$pval
  pval_label <- ifelse(pval < 0.0001, "p < 0.0001", paste("p =", round(pval, 4)))
  # SCIæœŸåˆŠæ ‡å‡†é…è‰²
  sci_palette <- c("#1F77B4", "#FF7F0E", "#2CA02C", "#D62728")  # è“ã€æ©™ã€ç»¿ã€çº¢
  
  # è‡ªåŠ¨è®¡ç®—æ—¶é—´é—´éš”
  max_time <- max(plot_data$aval, na.rm = TRUE)
  time_breaks <- pretty(seq(0, max_time, length.out = 8))
  break_step <- if(length(time_breaks) > 1) time_breaks[2] - time_breaks[1] else max_time/5
  
  # åˆ›å»ºåŸºç¡€å›¾å½¢ï¼ˆè§£å†³æ‰€æœ‰è­¦å‘Šï¼‰
  km_plot <- ggsurvplot(
    km_fit,
    data = plot_data,
    conf.int = TRUE,
    risk.table = TRUE,
    legend.title = "FI-Lab",
    legend.labs = c("Q1", "Q2", "Q3", "Q4"),
    palette = sci_palette,
    ggtheme = theme_bw(base_size = 12),
    title = title,
    xlab = "Time (days)",
    ylab = "Survival Probability",
    break.time.by = break_step,  # ç›´æ¥è®¾ç½®é—´éš”è§£å†³scaleè­¦å‘Š
    risk.table.height = 0.25,
    pval = pval_label,
    pval.coord = c(0, 0.1),
    censor = TRUE,
    censor.shape = 3,
    censor.size = 2.5,
    risk.table.col = "strata",
    risk.table.y.text = TRUE,  # æ˜¾ç¤ºåˆ†ç»„æ ‡ç­¾
    risk.table.y.text.col = TRUE,  # æ–‡æœ¬é¢œè‰²ä¸ç»„åˆ«ä¸€è‡´
    tables.theme = theme_cleantable(),
    font.title = c(14, "bold", "black"),
    font.x = c(12, "plain", "black"),
    font.y = c(12, "plain", "black"),
    font.legend = c(11, "plain", "black"),
    font.tickslab = c(10, "plain", "black"),
    legend = "top"  # å›¾ä¾‹ç½®äºé¡¶éƒ¨
  )
  
  # é«˜çº§ä¼˜åŒ–
  km_plot$plot <- km_plot$plot +
    theme(
      legend.position = "top",
      legend.direction = "horizontal",
      legend.box.spacing = unit(0.2, "cm"),
      plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
      panel.grid.minor = element_blank(),
      panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5)
    ) +
    guides(color = guide_legend(nrow = 1))
  
  # ä¼˜åŒ–é£é™©è¡¨ï¼ˆæ˜¾ç¤ºåˆ†ç»„æ ‡ç­¾ï¼‰
  km_plot$table <- km_plot$table +
    labs(y = NULL) +  # æ·»åŠ æ ‡ç­¾
    theme(
      axis.title.x = element_blank(),
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank(),
      plot.margin = margin(t = 5, b = 5),
      axis.title.y = element_text(size = 10, face = "bold")  # æ ‡ç­¾æ ·å¼
    )
  
  # ç»„åˆå›¾å½¢
  combined_plot <- arrange_ggsurvplots(
    list(km_plot),
    print = FALSE,
    ncol = 1,
    nrow = 1,
    heights = c(0.70, 0.30)
  )
  
  return(combined_plot)
}

# è¾“å‡ºå‡½æ•°ï¼ˆå¢åŠ JPGå’ŒSVGæ ¼å¼ï¼‰
save_km_plots <- function(plot_obj, testcd) {
  filename_base <- paste0("KM_plots/KM-", testcd)
  
  # å¤šç§æ ¼å¼è¾“å‡º
  ggsave(paste0(filename_base, ".png"), plot_obj, width = 8.5, height = 7, dpi = 300)
  ggsave(paste0(filename_base, ".tif"), plot_obj, width = 8.5, height = 7, dpi = 300, compression = "lzw")
  ggsave(paste0(filename_base, ".jpg"), plot_obj, width = 8.5, height = 7, dpi = 300)  # æ–°å¢JPG
  ggsave(paste0(filename_base, ".svg"), plot_obj, width = 8.5, height = 7, dpi = 300)  # æ–°å¢SVG
}

# ä¸»æ‰§è¡Œå‡½æ•°
create_all_km_plots <- function(tte_data) {
  testcd_list <- unique(tte_data$testcd)
  
  for (testcd in testcd_list) {
    tryCatch({
      km_plot <- generate_km_plots(tte_data, testcd)
      save_km_plots(km_plot, testcd)
      message(paste("æˆåŠŸåˆ›å»º", testcd, "çš„SCIæ ‡å‡†KMæ›²çº¿å›¾"))
    }, error = function(e) {
      message(paste("åˆ›å»º", testcd, "KMæ›²çº¿æ—¶å‡ºé”™:", e$message))
    })
  }
}

# æ‰§è¡Œå‡½æ•°
tte_xxdays<-tte %>%
  filter(testcd  %in% c("ICU28D" , "HOSPXXD"))
# æ‰§è¡Œå‡½æ•°ï¼ˆä½¿ç”¨æ‚¨çš„æ•°æ®é›†ï¼‰
create_all_km_plots(tte_xxdays)



```

## **é™åˆ¶æ€§ç«‹æ–¹æ ·æ¡æ›²çº¿ï¼ˆRCSï¼‰**

### RCS Knots é€‰æ‹©ä¾æ®knot 3-7çš„AICæ¯”è¾ƒï¼šç»“æœæ˜¾ç¤ºæ˜¯7ï¼Œä½†æ˜¯AICå’Œ4å·®åˆ«å¾ˆå°ï¼Œä»ç„¶é€‰ç”¨4ï¼Ÿ

```{r}
# Load required packages
library(survival)
library(rms)
library(dplyr)
library(officer)
library(flextable)
library(purrr)

# Function to calculate optimal knots using AIC
calculate_optimal_knots <- function(tte_data, testcd, covariates = NULL, knot_range = 3:7) {
  # Prepare data
  plot_data <- tte_data %>%
    dplyr::filter(testcd == !!testcd) %>%
    dplyr::select(-any_of(c("Q1", "Q2", "Q3", "Q4"))) %>%
    dplyr::mutate(flab100 = as.numeric(flab100)) %>% 
    dplyr::filter(!is.na(flab100))
  
  # Check variability
  if (length(unique(plot_data$flab100)) < 2 || 
      sd(plot_data$flab100, na.rm = TRUE) < .Machine$double.eps^0.5) {
    stop("Insufficient variability in flab100 [testcd: ", testcd, "]")
  }
  
  # Handle covariates
  if (!is.null(covariates)) {
    existing_covars <- covariates[covariates %in% names(plot_data)]
    plot_data <- plot_data %>%
      select(all_of(c("aval", "cnsr", "flab100", existing_covars))) %>%
      na.omit()
  }
  
  # Sample size checks
  if (nrow(plot_data) < 30) warning("Small sample size (n=", nrow(plot_data), ")")
  if (sum(plot_data$cnsr == 1) < 5) stop("Insufficient events (<5)")
  
  # Create datadist object BEFORE model fitting (fixes the error)
  dd <- datadist(plot_data)
  options(datadist = dd)#è¿™é‡Œä¹‹å‰å› ä¸ºç”¨äº†"dd"å¯¼è‡´äº†æŠ¥é”™ï¼Œæ³¨æ„ä¸å¸¦å¼•å·ï¼Œæ˜¯å¯¹è±¡ä¸æ˜¯å­—ç¬¦
  
  # Create survival object
  surv_obj <- Surv(time = plot_data$aval, event = plot_data$cnsr)
  
  # Initialize results storage
  results <- data.frame()
  models <- list()
  
  # Loop through knot range
  for (k in knot_range) {
    # Build formula
    if (is.null(covariates)) {
      formula_str <- "surv_obj ~ rcs(flab100, k)"
    } else {
      covar_formula <- paste(existing_covars, collapse = " + ")
      formula_str <- paste("surv_obj ~ rcs(flab100, k) +", covar_formula)
    }
    
    formula <- as.formula(formula_str)
    
    # Fit model
    fit <- tryCatch(
      {
        cph(formula, data = plot_data, x = TRUE, y = TRUE)
      },
      error = function(e) {
        warning("Fit failed for knots ", k, ": ", e$message)
        NULL
      }
    )
    
    # Calculate statistics
    if (!is.null(fit)) {
      loglik <- fit$loglik[2]
      df <- length(fit$coefficients)
      aic_val <- -2 * loglik + 2 * df
      bic_val <- -2 * loglik + log(nrow(plot_data)) * df
      
      # Extract ANOVA results
      anova_res <- anova(fit)
      overall_p <- ifelse("flab100" %in% rownames(anova_res), 
                          anova_res["flab100", "P"], NA)
      nonlinear_p <- ifelse("Nonlinear" %in% rownames(anova_res), 
                            anova_res["Nonlinear", "P"], NA)
      
      # Store results
      row <- data.frame(
        Knots = k,
        AIC = round(aic_val, 2),
        BIC = round(bic_val, 2),
        LogLikelihood = round(loglik, 2),
        DF = df,
        Overall_P = format_p(overall_p),
        Nonlinear_P = format_p(nonlinear_p),
        Converged = "Yes"
      )
      
      results <- rbind(results, row)
      models[[as.character(k)]] <- fit
    } else {
      row <- data.frame(
        Knots = k,
        AIC = NA,
        BIC = NA,
        LogLikelihood = NA,
        DF = NA,
        Overall_P = NA,
        Nonlinear_P = NA,
        Converged = "No"
      )
      results <- rbind(results, row)
    }
  }
  
  # Identify best knot
  best_row <- which.min(results$AIC)
  best_knot <- ifelse(length(best_row) > 0, results$Knots[best_row], NA)
  
  return(list(
    aic_table = results,
    best_knot = best_knot,
    models = models
  ))
}

# Format p-values
format_p <- function(p) {
  if (is.na(p)) return("NA")
  if (p < 0.001) "p < 0.001"
  else if (p < 0.01) "p < 0.01"
  else if (p < 0.05) "p < 0.05"
  else paste0("p = ", round(p, 3))
}

# Save AIC results to Word
save_aic_results <- function(aic_results, testcd, output_dir = "RCS_Results") {
  # Create output directory
  if (!dir.exists(output_dir)) {
    dir.create(output_dir, recursive = TRUE)
  }
  
  # Create Word document
  doc <- read_docx()
  
  # Add title
  title <- paste("AIC Knot Selection Report -", testcd)
  doc <- body_add_par(doc, title, style = "heading 1")
  doc <- body_add_par(doc, paste("Generated:", format(Sys.Date(), "%Y-%m-%d")), style = "Normal")
  doc <- body_add_par(doc, " ", style = "Normal")  # Blank line
  
  # Add summary
  doc <- body_add_par(doc, "Analysis Summary", style = "heading 2")
  
  summary_text <- paste0(
    "Test Code: ", testcd, "\n",
    "Sample Size: ", aic_results$sample_size, "\n",
    "Event Count: ", aic_results$event_count, "\n",
    "Optimal Knots: ", ifelse(is.na(aic_results$best_knot), "Not determined", aic_results$best_knot)
  )
  
  doc <- body_add_par(doc, summary_text, style = "Normal")
  doc <- body_add_par(doc, " ", style = "Normal")  # Blank line
  
  # Add statistics table
  doc <- body_add_par(doc, "Knot Comparison Statistics", style = "heading 2")
  
  # Format table
  ft <- flextable(aic_results$aic_table) %>%
    theme_zebra() %>%
    autofit() %>%
    set_caption(paste(testcd, "- Knot Comparison"))
  
  # Highlight best knot row
  if (!is.na(aic_results$best_knot)) {
    best_row <- which(aic_results$aic_table$Knots == aic_results$best_knot)
    ft <- bg(ft, i = best_row, bg = "#FFF2CC")
  }
  
  # Add column labels
  ft <- set_header_labels(ft,
                          Knots = "Knots",
                          AIC = "AIC",
                          BIC = "BIC",
                          LogLikelihood = "Log Likelihood",
                          DF = "Degrees of Freedom",
                          Overall_P = "Overall P-value",
                          Nonlinear_P = "Nonlinear P-value",
                          Converged = "Convergence Status")
  
  doc <- body_add_flextable(doc, value = ft)
  
  # Add explanations
  doc <- body_add_par(doc, "Metric Explanations", style = "heading 3")
  
  explanations <- c(
    "â€¢ AIC (Akaike Information Criterion): Lower values indicate better model fit",
    "â€¢ BIC (Bayesian Information Criterion): Similar to AIC with stronger penalty for complexity",
    "â€¢ Log Likelihood: Measure of model fit (higher absolute values indicate better fit)",
    "â€¢ Degrees of Freedom: Number of parameters in the model",
    "â€¢ Overall P-value: Significance test for the entire variable",
    "â€¢ Nonlinear P-value: Test for nonlinear relationship",
    "â€¢ Highlighted row indicates optimal knot selection based on AIC"
  )
  
  for (exp in explanations) {
    doc <- body_add_par(doc, exp, style = "Normal")
  }
  
  # Save Word document
  word_file <- file.path(output_dir, paste0("AIC_Selection_", testcd, ".docx"))
  print(doc, target = word_file)
  message("AIC results saved to: ", word_file)
}

# Main execution function
run_aic_analysis <- function(tte_data, covariates = NULL, output_dir = "RCS_Results") {
  testcd_list <- unique(tte_data$testcd)
  all_results <- list()
  
  for (testcd in testcd_list) {
    message("\n===== Analyzing: ", testcd, " =====")
    
    tryCatch({
      # Calculate sample size and event count
      plot_data <- tte_data %>%
        dplyr::filter(testcd == !!testcd) %>%
        dplyr::mutate(flab100 = as.numeric(flab100)) %>% 
        dplyr::filter(!is.na(flab100))
      
      sample_size <- nrow(plot_data)
      event_count <- sum(plot_data$cnsr == 1, na.rm = TRUE)
      
      # Perform AIC analysis
      aic_result <- calculate_optimal_knots(tte_data, testcd, covariates)
      
      # Add sample information
      aic_result$sample_size <- sample_size
      aic_result$event_count <- event_count
      
      # Save results
      save_aic_results(aic_result, testcd, output_dir)
      
      # Record results
      all_results[[testcd]] <- aic_result
      
      # Print summary
      message("Sample size: ", sample_size)
      message("Event count: ", event_count)
      message("Optimal knots: ", ifelse(is.na(aic_result$best_knot), "Not determined", aic_result$best_knot))
      message("AIC results saved")
      
    }, error = function(e) {
      message("âŒ Analysis failed: ", e$message)
      all_results[[testcd]] <<- paste("Failed:", e$message)
    })
  }
  
  return(all_results)
}

# ====================== Usage Example ====================== #
tte_xxdays <- tte %>%
  filter(testcd %in% c("ICU28D", "HOSPXXD"))  # ç¤ºä¾‹å¤šä¸ªtestcd
covariates_m2 <- metadata$variable_name[metadata$covars_m2 == 1]

# æ­¥éª¤2: æ‰§è¡ŒAICåˆ†æ
aic_results <- run_aic_analysis(
  tte_data = tte_xxdays,
  covariates = covariates_m2,
  output_dir = "RCS_Results"
)
```

### ä½¿ç”¨rmsåŒ…å®ç°é™åˆ¶æ€§ç«‹æ–¹æ ·æ¡ï¼ˆRestricted Cubic Splinesï¼‰æ¨¡å‹ï¼Œä»¥è¯„ä¼°è¿ç»­å˜é‡ä¸ç»“æœé—´çš„éçº¿æ€§å…³ç³»ã€‚è¿™é‡Œçš„Knotç‚¹æ•°ç”¨çš„æ˜¯4

```{r}
# åŠ è½½å¿…è¦åŒ…
library(survival)
library(rms)
library(ggplot2)
library(dplyr)
library(stringr)
library(gridExtra)
library(survminer)
library(scales)  # ç”¨äºé€æ˜è‰²å¤„ç†

# RCSæ›²çº¿ç”Ÿæˆå‡½æ•°ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
generate_rcs_plots <- function(tte_data, testcd, covariates = NULL) {
  
  # æ•°æ®å‡†å¤‡
  plot_data <- tte_data %>%
    filter(testcd == !!testcd) %>%
    select(-any_of(c("Q1","Q2","Q3","Q4")))%>%
    mutate(flab100 = as.numeric(flab100)) %>% 
    filter(!is.na(flab100))
  
  # å˜å¼‚åº¦æ£€æŸ¥
  if (length(unique(plot_data$flab100)) < 2 || 
      sd(plot_data$flab100, na.rm = TRUE) < .Machine$double.eps^0.5) {
    stop("å˜é‡flab100ç¼ºä¹å˜å¼‚åº¦ï¼ˆæ‰€æœ‰å€¼ç›¸åŒæˆ–æ¥è¿‘ï¼‰ï¼Œæ— æ³•è¿›è¡ŒRCSåˆ†æ [testcd: ", testcd, "]")
  }
  
  # å¦‚æœæœ‰åå˜é‡ï¼Œæ£€æŸ¥å¹¶å¤„ç†ç¼ºå¤±å€¼
  if (!is.null(covariates)) {
    # ç¡®ä¿åå˜é‡å­˜åœ¨
    existing_covars <- covariates[covariates %in% names(plot_data)]
    missing_covars <- setdiff(covariates, existing_covars)
    
    if (length(missing_covars) > 0) {
      warning("ç¼ºå°‘åå˜é‡: ", paste(missing_covars, collapse = ", "), 
              " [testcd: ", testcd, "]")
    }
    
    # å°†å­—ç¬¦å‹/é€»è¾‘å‹åå˜é‡è½¬æ¢ä¸ºå› å­
    # for (covar in existing_covars) {
    #   if (is.character(plot_data[[covar]]) {
    #     plot_data[[covar]] <- factor(plot_data[[covar]])
    #   } else if (is.logical(plot_data[[covar]])) {
    #     plot_data[[covar]] <- factor(plot_data[[covar]], levels = c(TRUE, FALSE))
    #   }
    # }
    
    # ç§»é™¤åå˜é‡ç¼ºå¤±å€¼
    plot_data <- plot_data %>%
      select(all_of(c("aval", "cnsr", "flab100", existing_covars))) %>%
      na.omit()
  }
  
  # æ ·æœ¬é‡æ£€æŸ¥
  if (nrow(plot_data) < 50) {
    warning("æ ·æœ¬é‡è¾ƒå°(n=", nrow(plot_data), ")ï¼Œç»“æœå¯èƒ½ä¸ç¨³å®š [testcd: ", testcd, "]")
  }
  
  if (sum(plot_data$cnsr == 1) < 10) {
    stop("äº‹ä»¶æ•°é‡ä¸è¶³(<10)ï¼Œæ— æ³•è¿›è¡Œå¯é åˆ†æ [testcd: ", testcd, "]")
  }
  
  # æ™ºèƒ½æ ‡é¢˜ç”Ÿæˆ
  title <- case_when(
    str_detect(testcd, "HOSP") ~ "In-hospital mortality",
    str_detect(testcd, "ICU") ~ {
      days <- str_extract(testcd, "\\d+")
      paste0(days, "-day all-cause mortality")
    },
    TRUE ~ paste(testcd, "Mortality")
  )
  
  # è®¾ç½®å‚è€ƒç‚¹ï¼ˆä¸­ä½æ•°ï¼‰
  ref_point <- median(plot_data$flab100, na.rm = TRUE)
  
  # åˆå§‹åŒ–rmsç¯å¢ƒ
  dd <- datadist(plot_data)
  options(datadist = dd)#è¿™é‡Œä¹‹å‰å› ä¸ºç”¨äº†"dd"å¯¼è‡´äº†æŠ¥é”™ï¼Œæ³¨æ„ä¸å¸¦å¼•å·ï¼Œæ˜¯å¯¹è±¡ä¸æ˜¯å­—ç¬¦
  
  # æ„å»ºç”Ÿå­˜å¯¹è±¡
  surv_obj <- Surv(time = plot_data$aval, event = plot_data$cnsr)
  
  # æ„å»ºæ¨¡å‹å…¬å¼ - ä¿®å¤è­¦å‘Šé—®é¢˜
  if (is.null(covariates)) {
    formula <- surv_obj ~ rcs(flab100, 4)
    model_type <- "Univariate"
  } else {
    # è¿‡æ»¤å­˜åœ¨çš„åå˜é‡
    existing_covars <- covariates[covariates %in% names(plot_data)]
    
    if (length(existing_covars) == 0) {
      formula <- surv_obj ~ rcs(flab100, 4)
      model_type <- "Univariate (no valid covariates)"
    } else {
      # ä¿®å¤å…¬å¼æ„å»ºæ–¹å¼ï¼Œé¿å…å­—ç¬¦å‘é‡è­¦å‘Š
      covar_formula <- paste(existing_covars, collapse = " + ")
      formula_str <- paste("surv_obj ~ rcs(flab100, 4) +", covar_formula)
      formula <- as.formula(formula_str)  # æ˜¾å¼è½¬æ¢ä¸ºå…¬å¼å¯¹è±¡
      model_type <- paste("Adjusted for:", paste(existing_covars, collapse = ", "))
    }
  }
  
  # æ‹ŸåˆRCSæ¨¡å‹
  rcs_fit <- tryCatch(
    {
      cph(formula, data = plot_data, x = TRUE, y = TRUE)
    },
    error = function(e) {
      stop("æ¨¡å‹æ‹Ÿåˆå¤±è´¥: ", e$message, " [testcd: ", testcd, "]")
    }
  )
  
  # æå–På€¼ - ä¿®å¤è¯­æ³•é”™è¯¯
  extract_p_value <- function(anova_obj) {
    results <- list(overall = NA, nonlinear = NA)
    rownames_anova <- rownames(anova_obj)
    
    # å°è¯•æå–æ•´ä½“På€¼
    if ("flab100" %in% rownames_anova) {
      results$overall <- anova_obj["flab100", "P"]
    } else {
      # å°è¯•åŒ¹é…åŒ…å«"flab100"çš„è¡Œ
      idx <- grep("flab100", rownames_anova, fixed = TRUE)
      if (length(idx) > 0) {
        results$overall <- anova_obj[idx[1], "P"]
      }
    }
    
    # å°è¯•æå–éçº¿æ€§På€¼
    if ("Nonlinear" %in% rownames_anova) {
      results$nonlinear <- anova_obj["Nonlinear", "P"]
    } else {
      # å°è¯•åŒ¹é…åŒ…å«"Nonlinear"çš„è¡Œ
      idx <- grep("Nonlinear", rownames_anova, fixed = TRUE)
      if (length(idx) > 0) {
        results$nonlinear <- anova_obj[idx[1], "P"]
      }
    }
    
    results
  }
  
  anova_test <- anova(rcs_fit)
  p_values <- extract_p_value(anova_test)
  
  # æ ¼å¼åŒ–På€¼æ ‡ç­¾
  format_p <- function(p) {
    if (is.na(p)) return("p = NA")
    if (p < 0.001) {
      "p < 0.001"
    } else if (p < 0.01) {
      "p < 0.01"
    } else if (p < 0.05) {
      "p < 0.05"
    } else {
      paste("p =", round(p, 3))
    }
  }
  
  p_label <- paste0(
    "Overall: ", format_p(p_values$overall), 
    "\nNon-linear: ", format_p(p_values$nonlinear)
  )
  
  # ç”Ÿæˆé¢„æµ‹æ•°æ®
  pred_range <- range(plot_data$flab100, na.rm = TRUE)
  pred_data <- data.frame(flab100 = seq(
    pred_range[1],
    pred_range[2],
    length.out = 200
  ))
  
  # æ·»åŠ åå˜é‡ä¸­ä½æ•°/ä¼—æ•°ï¼ˆå¦‚æœæœ‰å¤šå˜é‡ï¼‰
  if (!is.null(covariates) && length(existing_covars) > 0) {
    for (covar in existing_covars) {
      if (is.numeric(plot_data[[covar]])) {
        pred_data[[covar]] <- median(plot_data[[covar]], na.rm = TRUE)
      } else if (is.factor(plot_data[[covar]])) {
        # å› å­å˜é‡å–æœ€å¸¸è§æ°´å¹³å¹¶ä¿æŒå› å­ç»“æ„
        tab <- table(plot_data[[covar]])
        mode_value <- names(sort(tab, decreasing = TRUE))[1]
        pred_data[[covar]] <- factor(mode_value, levels = levels(plot_data[[covar]]))
      } else {
        # å…¶ä»–ç±»å‹å–æœ€å¸¸è§å€¼
        pred_data[[covar]] <- names(sort(table(plot_data[[covar]]), decreasing = TRUE))[1]
      }
    }
  }
  
  # è®¡ç®—é¢„æµ‹å€¼
  pred <- Predict(
    rcs_fit, 
    flab100 = pred_data$flab100,
    ref.zero = TRUE, 
    fun = exp
  )
  
  # ====== é«˜çº§é…è‰²æ–¹æ¡ˆï¼ˆNatureæœŸåˆŠé£æ ¼ï¼‰ ======
  primary_color <- "#2E5A87"  # æ·±è“è‰²ï¼ˆä¸»æ›²çº¿ï¼‰
  ribbon_color <- alpha("#6C9BCF", 0.2)  # åŠé€æ˜æµ…è“è‰²ï¼ˆç½®ä¿¡åŒºé—´ï¼‰
  ref_line_color <- "#D93B3B"  # çº¢è‰²ï¼ˆå‚è€ƒçº¿ï¼‰
  histogram_color <- alpha("#4D7EA8", 0.6)  # åŠé€æ˜è“è‰²ï¼ˆç›´æ–¹å›¾ï¼‰
  
  # ====== æ•´åˆç›´æ–¹å›¾åˆ°ä¸»å›¾ ======
  # åˆ›å»ºç›´æ–¹å›¾æ•°æ®ï¼ˆä½¿ç”¨æ›´å¯é çš„layer_dataå‡½æ•°ï¼‰
  hist_plot <- ggplot(plot_data, aes(x = flab100)) + 
    geom_histogram(bins = 30, fill = histogram_color)
  
  hist_data <- layer_data(hist_plot)  # æ›´å¯é çš„è·å–æ–¹å¼
  
  # ç¡®ä¿æœ‰xä½ç½®æ•°æ®
  if (!"x" %in% names(hist_data)) {
    if (all(c("xmin", "xmax") %in% names(hist_data))) {
      hist_data$x <- (hist_data$xmin + hist_data$xmax)/2
    } else {
      stop("æ— æ³•ç¡®å®šç›´æ–¹å›¾ä¸­å¿ƒä½ç½®")
    }
  }
  
  # è®¡ç®—å®½åº¦
  if (all(c("xmin", "xmax") %in% names(hist_data))) {
    hist_data$width <- hist_data$xmax - hist_data$xmin
  } else {
    # ä¼°ç®—å®½åº¦ä½œä¸ºå¤‡é€‰
    unique_x <- unique(hist_data$x)
    avg_width <- if (length(unique_x) > 1) mean(diff(sort(unique_x))) else 1
    hist_data$width <- rep(avg_width, nrow(hist_data))
  }
  
  # ç¼©æ”¾ç›´æ–¹å›¾é«˜åº¦ï¼ˆé€‚é…HRåæ ‡è½´ï¼‰
  y_max <- max(pred$upper, na.rm = TRUE)
  
  # å®‰å…¨å¤„ç†é›¶è®¡æ•°æƒ…å†µ
  if (max(hist_data$count) == 0) {
    hist_scale_factor <- 0
  } else {
    hist_scale_factor <- 0.2 * y_max / max(hist_data$count)
  }
  
  hist_data$scaled_count <- hist_data$count * hist_scale_factor
  
  # ====== åˆ›å»ºä¸»å›¾ ======
  rcs_plot <- ggplot() +
    # 1. æ·»åŠ ç›´æ–¹å›¾ï¼ˆåº•éƒ¨ï¼‰
    geom_bar(
      data = hist_data,
      aes(x = x, y = scaled_count),
      stat = "identity",
      width = hist_data$width,  # ä½¿ç”¨æ¯åˆ—çš„å®½åº¦
      fill = histogram_color,
      color = NA
    ) +
    # 2. æ·»åŠ HRå‚è€ƒçº¿
    geom_hline(yintercept = 1, linetype = "dashed", color = "gray50", linewidth = 0.6) +
    # 3. æ·»åŠ ç½®ä¿¡åŒºé—´
    geom_ribbon(
      data = pred,
      aes(x = flab100, ymin = lower, ymax = upper),
      alpha = 0.2,
      fill = primary_color
    ) +
    # 4. æ·»åŠ ä¸»æ›²çº¿
    geom_line(
      data = pred,
      aes(x = flab100, y = yhat),
      linewidth = 1.5,
      color = primary_color
    ) +
    # 5. æ·»åŠ å‚è€ƒçº¿
    geom_vline(
      xintercept = ref_point,
      linetype = "dashed",
      color = ref_line_color,
      linewidth = 0.5
    ) +
    # 6. æ·»åŠ På€¼æ ‡ç­¾
    annotate(
      "text",
      x = Inf, y = Inf,
      label = p_label,
      hjust = 1.1, vjust = 1.5,
      size = 4.5,
      fontface = "bold"
    ) +
    # 7. æ·»åŠ æ¨¡å‹ç±»å‹æ ‡ç­¾
    # annotate(
    #   "text",
    #   x = -Inf, y = Inf,
    #   label = model_type,
    #   hjust = -0.05, vjust = 1.5,
    #   size = 4.0,
    #   color = "gray30",
    #   fontface = "italic"
    # ) +
    # 8. æ·»åŠ ä¸­ä½æ•°æ ‡ç­¾
    # annotate(
    #   "text",
    #   x = ref_point,
    #   y = 0,
    #   label = paste0("Median: ", round(ref_point, 2)),
    #   vjust = -0.5,
    #   hjust = 0.5,
    #   size = 4.0,
    #   color = ref_line_color,
    #   fontface = "bold"
    # ) +
    # åæ ‡è½´å’Œæ ‡ç­¾
    labs(
      title = title,
      x = "FI-Lab",  # ä¿®æ”¹ä¸ºFI-Lab
      y = "Hazard Ratio (95% CI)"
    ) +
    # æ‰©å±•Yè½´åº•éƒ¨ç©ºé—´ä»¥æ˜¾ç¤ºç›´æ–¹å›¾
    scale_y_continuous(expand = expansion(mult = c(0.05, 0.15))) +
    # NatureæœŸåˆŠé£æ ¼ä¸»é¢˜
    theme_minimal(base_size = 14) +
    theme(
      plot.title = element_text(
        hjust = 0.5,
        face = "bold",
        size = 16,
        margin = margin(b = 15)
      ),
      panel.grid.minor = element_blank(),
      panel.grid.major = element_line(color = "grey90", linewidth = 0.25),
      panel.background = element_rect(fill = "white", color = NA),
      plot.background = element_rect(fill = "white", color = NA),
      axis.line = element_line(color = "black", linewidth = 0.5),
      axis.title = element_text(face = "bold", size = 13),
      axis.text = element_text(color = "black", size = 11),
      plot.margin = margin(20, 20, 20, 20)
    )
  
  return(rcs_plot)
}

# å›¾å½¢ä¿å­˜å‡½æ•°
save_rcs_plots <- function(plot_obj, testcd, output_dir = "results") {
  # åˆ›å»ºè¾“å‡ºç›®å½•
  if (!dir.exists(output_dir)) {
    dir.create(output_dir, recursive = TRUE)
  }
  
  filename_base <- file.path(output_dir, paste0("RCS-", testcd))
  
  # ä¿å­˜å¤šç§æ ¼å¼
  ggsave(paste0(filename_base, ".png"), plot_obj, width = 9, height = 7, dpi = 300, bg = "white")
  ggsave(paste0(filename_base, ".jpg"), plot_obj, width = 9, height = 7, dpi = 300, bg = "white")
  ggsave(paste0(filename_base, ".svg"), plot_obj, width = 9, height = 7, bg = "white")
  ggsave(paste0(filename_base, ".tif"), plot_obj, width = 9, height = 7, dpi = 300, compression = "lzw")
  
  message("ä¿å­˜å›¾å½¢: ", filename_base, ".[png|jpg|tif|.svg]")
}

# ä¸»æ‰§è¡Œå‡½æ•°
create_all_rcs_plots <- function(tte_data, covariates = NULL, output_dir = "results") {
  testcd_list <- unique(tte_data$testcd)
  
  results <- list()
  errors <- list()
  
  for (testcd in testcd_list) {
    tryCatch({
      message("\n===== å¤„ç†: ", testcd, " =====")
      
      start_time <- Sys.time()
      rcs_plot <- generate_rcs_plots(tte_data, testcd, covariates)
      save_rcs_plots(rcs_plot, testcd, output_dir)
      
      elapsed <- round(as.numeric(Sys.time() - start_time), 1)
      message(paste0("âœ… æˆåŠŸåˆ›å»º (è€—æ—¶: ", elapsed, "s)"))
      results[[testcd]] <- rcs_plot
    }, error = function(e) {
      msg <- paste("âŒ å¤±è´¥:", e$message)
      message(msg)
      errors[[testcd]] <<- msg
    })
  }
  
  # ç”ŸæˆæŠ¥å‘Š
  message("\n===== å¤„ç†å®Œæˆ =====")
  message("æˆåŠŸ: ", length(results), "/", length(testcd_list))
  message("å¤±è´¥: ", length(errors))
  
  if (length(errors) > 0) {
    message("\nå¤±è´¥è¯¦æƒ…:")
    for (testcd in names(errors)) {
      message("- ", testcd, ": ", errors[[testcd]])
    }
  }
  
  invisible(list(success = results, errors = errors))
}

# ä½¿ç”¨ç¤ºä¾‹ ================================================================

# æ­¥éª¤1: å‡†å¤‡åå˜é‡ï¼ˆæ ¹æ®metadataï¼‰
# å‡è®¾metadataæ˜¯ä¸€ä¸ªæ•°æ®æ¡†ï¼ŒåŒ…å«å˜é‡åå’Œé€‰æ‹©æ ‡å¿—
covariates_m2 <- metadata$variable_name[metadata$covars_m2 == 1]

# æ­¥éª¤2: åˆ›å»ºå­é›†
tte_xxdays <- tte %>%
  filter(testcd %in% c("ICU28D", "HOSPXXD"))  # ç¤ºä¾‹å¤šä¸ªtestcd

# æ­¥éª¤3: æ‰§è¡Œå‡½æ•°ï¼Œä½¿ç”¨model 2æ„å»º
results <- create_all_rcs_plots(
  tte_data = tte_xxdays,
  covariates = covariates_m2,
  output_dir = "RCS_Results"
)
```

## **Forest Plotï¼ˆæ£®æ—å›¾ï¼‰**

#### ä½¿ç”¨forestplotåŒ…åˆ›å»ºé«˜è´¨é‡çš„æ£®æ—å›¾ï¼Œå±•ç¤ºä¸åŒäºšç»„çš„é£é™©æ¯”å’Œç½®ä¿¡åŒºé—´ã€‚

### 1. ä½¿ç”¨è¿ç»­å˜é‡ç»˜å›¾ï¼šå‚è€ƒæ ·å¼

![](https://pmc.ncbi.nlm.nih.gov/articles/PMC11806754/figure/Fig4/)

```{r}
# ä¿®å¤åçš„å®Œæ•´ä»£ç  - æ·»åŠ På€¼åˆ—å’Œå¤štestcdè¾“å‡º
if(!require(forestplot)) install.packages("forestplot")
if(!require(survival)) install.packages("survival")
if(!require(dplyr)) install.packages("dplyr")
if(!require(tidyr)) install.packages("tidyr")
library(forestplot)
library(survival)
library(dplyr)
library(tidyr)

# å®šä¹‰è¦åˆ†æçš„testcdåˆ—è¡¨ - æŒ‰éœ€ä¿®æ”¹
testcd_list <- c("ICU28D", "HOSPXXD")  # æ›¿æ¢ä¸ºæ‚¨çš„ä¸‰ä¸ªtestcdå€¼

# éå†æ¯ä¸ªtestcdç”Ÿæˆæ£®æ—å›¾
for (current_testcd in testcd_list) {
  # è¯»å–æ•°æ®
  # ç­›é€‰ç‰¹å®štestcd
  data <- tte %>% 
    filter(testcd == current_testcd)  # æ ¹æ®éœ€æ±‚ä¿®æ”¹
  
  # ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„åå˜é‡å’Œäºšç»„å˜é‡ - æ ¹æ®æ‚¨çš„å®é™…è®¾ç½®
  covariates_m2 <- metadata$variable_name[metadata$covars_m2 == 1]
  subgroup_vars <- metadata$variable_name[metadata$subgroup == 1]
  
  # ç¡®ä¿æ—¶é—´å’Œäº‹ä»¶å˜é‡æ˜¯æ•°å€¼å‹
  data$time <- as.numeric(data$aval)
  data$event <- as.numeric(data$cnsr)
  
  # å­˜å‚¨äºšç»„åˆ†æç»“æœ
  subgroup_results <- list()
  interaction_p_values <- list()
  
  # å¯¹æ¯ä¸ªäºšç»„å˜é‡è¿›è¡Œåˆ†æ
  for (var_name in subgroup_vars) {
    # è·å–å˜é‡ç±»åˆ«
    if (is.numeric(data[[var_name]])) {
      # æ•°å€¼å˜é‡è½¬æ¢ä¸ºäºŒåˆ†å˜é‡
      median_val <- median(data[[var_name]], na.rm = TRUE)
      var_categories <- c(paste0("â‰¤", median_val), paste0(">", median_val))
    } else {
      var_categories <- sort(unique(na.omit(data[[var_name]])))
    }
    
    results_for_var <- list()
    
    # å¯¹è¯¥å˜é‡çš„æ¯ä¸ªç±»åˆ«è¿›è¡Œäºšç»„åˆ†æ
    for (category in var_categories) {
      if (is.numeric(data[[var_name]])) {
        # æ•°å€¼å˜é‡çš„ç‰¹æ®Šå¤„ç†
        if (grepl("â‰¤", category)) {
          cutoff <- as.numeric(gsub("â‰¤", "", category))
          subset_data <- data[data[[var_name]] <= cutoff, ]
        } else {
          cutoff <- as.numeric(gsub(">", "", category))
          subset_data <- data[data[[var_name]] > cutoff, ]
        }
      } else {
        subset_data <- data[data[[var_name]] == category, ]
      }
      
      # è®¡ç®—æ€»äººæ•°å’Œäº‹ä»¶æ•°ï¼ˆç™¾åˆ†æ¯”ï¼‰
      total_n <- nrow(subset_data)
      event_n <- sum(subset_data$event == 1, na.rm = TRUE)
      event_percent <- round(event_n / total_n * 100, 1)
      event_str <- sprintf("%d (%0.1f%%)", event_n, event_percent)
      
      # åœ¨å­é›†ä¸Šæ‹ŸåˆCoxæ¨¡å‹
      tryCatch({
        # æ„å»ºåå˜é‡å…¬å¼
        cov_formula <- if (length(covariates_m2) > 0) {
          paste(covariates_m2, collapse = " + ")
        } else {
          "1"
        }
        
        model_formula <- as.formula(paste("Surv(time, event) ~ flab100 +", cov_formula))
        model <- coxph(model_formula, data = subset_data)
        
        # æå–ç»“æœ
        summary_result <- summary(model)
        coefs <- summary_result$coefficients
        
        # æå–å…³äºæš´éœ²å˜é‡çš„ç³»æ•°
        exposure_row <- which(grepl("flab100", rownames(coefs)))
        
        if (length(exposure_row) > 0) {
          hr <- exp(coefs[exposure_row, "coef"])
          lower_ci <- exp(coefs[exposure_row, "coef"] - 1.96 * coefs[exposure_row, "se(coef)"])
          upper_ci <- exp(coefs[exposure_row, "coef"] + 1.96 * coefs[exposure_row, "se(coef)"])
          p_value <- coefs[exposure_row, "Pr(>|z|)"]  # æå–På€¼
          
          # ä¿å­˜ç»“æœ
          results_for_var[[as.character(category)]] <- data.frame(
            Subgroup = var_name,
            Category = category,
            Level = gsub("flab100", "", rownames(coefs)[exposure_row]),
            Total = total_n,
            Event = event_str,
            HR = hr,
            Lower_CI = lower_ci,
            Upper_CI = upper_ci,
            P_value = p_value,  # æ·»åŠ På€¼åˆ—
            stringsAsFactors = FALSE
          )
        }
      }, error = function(e) {
        message(paste("Error in subgroup", var_name, "-", category, ":", e$message))
      })
    }
    
    # åˆå¹¶è¯¥å˜é‡çš„æ‰€æœ‰ç±»åˆ«ç»“æœ
    if (length(results_for_var) > 0) {
      var_df <- do.call(rbind, results_for_var)
      subgroup_results[[var_name]] <- var_df
      
      # è®¡ç®—äº¤äº’På€¼
      interaction_formula <- as.formula(
        paste("Surv(time, event) ~ flab100 *", var_name, "+", 
              paste(covariates_m2, collapse = " + "))
      )
      
      interaction_model <- tryCatch({
        coxph(interaction_formula, data = data)
      }, error = function(e) {
        return(NULL)
      })
      
      if (!is.null(interaction_model)) {
        interaction_terms <- grep(paste0("flab100.*:", var_name), names(coef(interaction_model)), value = TRUE)
        if (length(interaction_terms) > 0) {
          interaction_p <- coef(summary(interaction_model))[interaction_terms, "Pr(>|z|)"]
          interaction_p_values[[var_name]] <- data.frame(
            Subgroup = var_name,
            Category = "Interaction",
            Level = "P for interaction",
            Total = NA,
            Event = NA,
            HR = NA,
            Lower_CI = NA,
            Upper_CI = NA,
            P_value = NA,
            P_interaction = min(interaction_p)  # å–æœ€å°på€¼
          )
        }
      }
    }
  }
  
  # åˆå¹¶æ‰€æœ‰äºšç»„ç»“æœ
  all_subgroups_results <- if (length(subgroup_results) > 0) {
    do.call(rbind, subgroup_results)
  } else {
    data.frame()
  }
  if (length(interaction_p_values) > 0) {
    interaction_df <- do.call(rbind, interaction_p_values)
  } else {
    interaction_df <- data.frame(Subgroup="",P_interaction="NA")
  }
  
  # P_interaction <- interaction_df %>% select(Subgroup, P_interaction)
  
  # åˆå¹¶æ•°æ®é›†
  all_subgroups_results <- all_subgroups_results %>%
    left_join(interaction_df %>% select(Subgroup, P_interaction), by = "Subgroup")
  
  # æ·»åŠ Overallè¡Œ - æ€»ä½“æ•ˆåº”
  tryCatch({
    # æ„å»ºåå˜é‡å…¬å¼
    cov_formula <- if (length(covariates_m2) > 0) {
      paste(covariates_m2, collapse = " + ")
    } else {
      "1"
    }
    
    model_formula <- as.formula(paste("Surv(time, event) ~ flab100 +", cov_formula))
    overall_model <- coxph(model_formula, data = data)
    
    # æå–ç»“æœ
    summary_result <- summary(overall_model)
    coefs <- summary_result$coefficients
    
    # æå–å…³äºæš´éœ²å˜é‡çš„ç³»æ•°
    exposure_row <- which(grepl("flab100", rownames(coefs)))
    
    if (length(exposure_row) > 0) {
      hr <- exp(coefs[exposure_row, "coef"])
      lower_ci <- exp(coefs[exposure_row, "coef"] - 1.96 * coefs[exposure_row, "se(coef)"])
      upper_ci <- exp(coefs[exposure_row, "coef"] + 1.96 * coefs[exposure_row, "se(coef)"])
      p_value <- coefs[exposure_row, "Pr(>|z|)"]  # æå–På€¼
      
      # è®¡ç®—æ€»äººæ•°å’Œäº‹ä»¶æ•°
      total_n <- nrow(data)
      event_n <- sum(data$event == 1, na.rm = TRUE)
      event_percent <- round(event_n / total_n * 100, 1)
      event_str <- sprintf("%d (%0.1f%%)", event_n, event_percent)
      
      # åˆ›å»ºOverallè¡Œ
      overall_row <- data.frame(
        Subgroup = "Overall",
        Category = "Overall",
        Level = "",
        Total = total_n,
        Event = event_str,
        HR = hr,
        Lower_CI = lower_ci,
        Upper_CI = upper_ci,
        P_value = p_value,  # æ·»åŠ På€¼
        P_interaction = NA,
        stringsAsFactors = FALSE
      )
      
      # å°†Overallè¡Œæ·»åŠ åˆ°ç»“æœé¡¶éƒ¨
      all_subgroups_results <- bind_rows(overall_row, all_subgroups_results)
    }
  }, error = function(e) {
    message(paste("Error in overall model:", e$message))
  })
  
  # ä½¿ç”¨metadataä¸­çš„æ ‡ç­¾æ›¿æ¢å˜é‡å
  # å‡è®¾metadataåŒ…å«variable_nameå’Œlabelåˆ—
  if (!is.null(metadata) && "label" %in% colnames(metadata)) {
    # åˆ›å»ºä»å˜é‡ååˆ°æ ‡ç­¾çš„æ˜ å°„
    label_mapping <- setNames(metadata$label, metadata$variable_name)
    # æ·»åŠ Overallçš„æ˜ å°„
    label_mapping["Overall"] <- "Overall"
    
    # æ›¿æ¢Subgroupåˆ—
    all_subgroups_results$Subgroup <- ifelse(
      all_subgroups_results$Subgroup %in% names(label_mapping),
      label_mapping[all_subgroups_results$Subgroup],
      all_subgroups_results$Subgroup
    )
  }
  
  # è½¬æ¢Categoryæ˜¾ç¤º
  all_subgroups_results <- all_subgroups_results %>%
    mutate(
      Category = case_when(
        Subgroup !="AKI stage" & Category == "0" ~ "No",
        Subgroup !="AKI stage" & Category == "1" ~ "Yes",
        Category == "F" ~ "Female",
        Category == "M" ~ "Male",
        TRUE ~ as.character(Category)
      )
    )
  
  # æ ¼å¼åŒ–æ•°æ®ç”¨äºæ£®æ—å›¾
  if (nrow(all_subgroups_results) == 0) {
    stop("äºšç»„åˆ†ææœªç”Ÿæˆä»»ä½•ç»“æœï¼Œè¯·æ£€æŸ¥æ•°æ®ã€äºšç»„å˜é‡å’Œæ¨¡å‹å…¬å¼")
  }
  
  # åˆ›å»ºä¸“ä¸šåŒ»å­¦æœŸåˆŠé£æ ¼çš„æ£®æ—å›¾æ•°æ®
  # ä»metadataä¸­æå–æ’åºé¡ºåº
  if (!is.null(metadata) && "order" %in% colnames(metadata)) {
    # åˆ›å»ºæ’åºæ˜ å°„
    order_mapping <- setNames(metadata$order[metadata$subgroup==1], metadata$label[metadata$subgroup==1])
    # æ·»åŠ Overallçš„æ’åºï¼ˆè®¾ä¸º0ï¼‰
    order_mapping <- c(order_mapping, setNames(0, "Overall"))
  } else {
    # å¦‚æœmetadataä¸­æ²¡æœ‰orderåˆ—ï¼Œåˆ›å»ºé»˜è®¤æ’åº
    unique_subgroups <- setdiff(unique(all_subgroups_results$Subgroup), "Overall")
    order_mapping <- setNames(1:length(unique_subgroups), unique_subgroups)
    order_mapping["Overall"] <- 0
  }
  
  # å°†æ’åºé¡ºåºåº”ç”¨åˆ°æ•°æ®
  all_subgroups_results <- all_subgroups_results %>%
    mutate(
      Order = order_mapping[Subgroup],
      # ç¡®ä¿Overallæ’åœ¨æœ€å‰é¢
      Order = ifelse(Subgroup == "Overall", 0, Order)
    ) %>%
    arrange(Order, Subgroup, Category)
  
  # æå–Subgroup label,ä¸ºæ¥ä¸‹æ¥æ‹¼æ¥åšå‡†å¤‡
  Group_Header<-all_subgroups_results %>%
    filter(Subgroup !="Overall")%>%
    distinct(Order,Subgroup,P_interaction) %>%
    select(Order,Subgroup,P_interaction)
  
  # 1. æ‹¼æ¥Subgroup label,å¹¶ç¼©è¿› categoryå†…å®¹
  # 2. å¤„ç†HR_CIï¼ŒPå€¼ format
  # 3. P for interaction ä»…å‡ºç°åœ¨subgroup header é‚£ä¸€è¡Œ
  forest_data <- all_subgroups_results %>% 
    bind_rows(Group_Header) %>%
    mutate(
      HR_CI = ifelse(is.na(HR),"",sprintf("%.2f (%.2f-%.2f)", HR, Lower_CI, Upper_CI)),
      P_value_str = ifelse(is.na(P_value), "", 
                           ifelse(P_value < 0.001, "<0.001", sprintf("%.3f", P_value))),  # æ ¼å¼åŒ–På€¼
      P_interaction = ifelse(is.na(P_interaction), "", 
                             ifelse(P_interaction < 0.001, "<0.001", sprintf("%.3f", P_interaction)))
    ) %>%
    arrange(Order,Subgroup,desc(is.na(Category)),Category) %>%
    mutate(Group_Header = ifelse(!is.na(Category) & Category!="Overall", paste0("  ", as.character(Category)), Subgroup),
           P_interaction = ifelse(!duplicated(P_interaction), P_interaction, "")
    ) %>%
    select(Group_Header, Total, Event, HR_CI, P_value_str, HR, Lower_CI, Upper_CI,   P_interaction) %>%  # æ·»åŠ På€¼åˆ—
    relocate(Group_Header, Total, Event, HR_CI, P_value_str,P_interaction)  # è°ƒæ•´åˆ—é¡ºåº
  
  # ä¿®å¤ç±»å‹ä¸åŒ¹é…é—®é¢˜
  forest_data <- forest_data %>%
    mutate(
      Total = ifelse(is.na(Total), "", as.character(Total)),
      Event = ifelse(is.na(Event), "", as.character(Event))
    )
  
  # æ·»åŠ è¡¨å¤´è¡Œ - åŒ…å«På€¼åˆ—
  header <- data.frame(
    Group_Header = "Subgroup",
    Total = "Total n",
    Event = "Event n (%)",
    HR_CI = "HR (95% CI)",
    P_value_str = "P-value",  # æ·»åŠ På€¼åˆ—æ ‡é¢˜
    P_interaction = "P for interaction",
    stringsAsFactors = FALSE
  )
  
  # åˆå¹¶æ•°æ®ï¼ˆè¡¨å¤´åœ¨æœ€å‰é¢ï¼‰
  forest_data <- bind_rows(header, forest_data)
  
  # æ ‡è¯†ç»„æ ‡é¢˜è¡Œ
  is_header <- forest_data$Group_Header != "" | 
    forest_data$Group_Header == "Subgroup"  # åŒ…å«è¡¨å¤´è¡Œ
  
  # åˆ›å»ºæ ‡è¯†æ±‡æ€»è¡Œï¼ˆéœ€è¦åŠ ç²—çš„è¡Œï¼‰çš„é€»è¾‘å‘é‡
  summary_vector <- rep(FALSE, nrow(forest_data))
  
  # è¡¨å¤´è¡Œï¼ˆç¬¬ä¸€è¡Œï¼‰éœ€è¦åŠ ç²—
  summary_vector[1] <- TRUE
  for (i in 2:nrow(forest_data)) {
    # è·å–å½“å‰è¡Œçš„Group_Headerå†…å®¹
    current_header <- forest_data$Group_Header[i]
    
    # è¯†åˆ«Overallè¡Œ
    if (current_header == "Overall") {
      summary_vector[i] <- TRUE
    }
    # è¯†åˆ«äºšç»„æ ‡é¢˜è¡Œ - é€šè¿‡æ£€æŸ¥æ˜¯å¦æ˜¯æœªç¼©è¿›çš„æ ‡é¢˜
    else if (!startsWith(current_header, "  ")) {
      summary_vector[i] <- TRUE
    }
  }
  # åˆ›å»ºä¸forest_dataè¡Œæ•°åŒ¹é…çš„HRæ•°æ®å‘é‡
  # åˆå§‹åŒ–æ‰€æœ‰è¡Œä¸ºNA
  mean_vals <- rep(NA, nrow(forest_data))
  lower_vals <- rep(NA, nrow(forest_data))
  upper_vals <- rep(NA, nrow(forest_data))
  
  # æ‰¾å‡ºå®é™…æœ‰HRæ•°æ®çš„è¡Œï¼ˆç±»åˆ«è¡Œï¼‰
  category_rows <- which(!is.na(forest_data$HR))
  
  # ä»all_subgroups_resultsä¸­æå–HRæ•°æ®å¡«å……åˆ°æ­£ç¡®ä½ç½®
  if (length(category_rows) > 0 && nrow(forest_data) > 0) {
    mean_vals[category_rows] <- forest_data$HR[category_rows]
    lower_vals[category_rows] <- forest_data$Lower_CI[category_rows]
    upper_vals[category_rows] <- forest_data$Upper_CI[category_rows]
  }
  
  # åˆ›å»ºæ–‡æœ¬çŸ©é˜µ - åŒ…å«På€¼åˆ—
  label_matrix <- as.matrix(forest_data[, c("Group_Header",  "Total", "Event",  "HR_CI", "P_value_str", "P_interaction")])
  
  # ç¡®å®šåˆé€‚çš„xè½´èŒƒå›´
  all_hr_vals <- na.omit(c(all_subgroups_results$Lower_CI, all_subgroups_results$Upper_CI))
  if (length(all_hr_vals) > 0) {
    x_min <- max(0.5, floor(min(all_hr_vals)*10)/10)  # ç¡®ä¿æœ€å°å€¼ä¸ä½äº0.5
    x_max <- min(2.5, ceiling(max(all_hr_vals)*10)/10) # ç¡®ä¿æœ€å¤§å€¼ä¸è¶…è¿‡2.5
    x_ticks <- seq(x_min, x_max, length.out = 5)       # åˆ›å»º5ä¸ªåˆ»åº¦ç‚¹
  } else {
    x_min <- 0.5
    x_max <- 2.0
    x_ticks <- c(0.5, 1.0, 1.5, 2.0)
  }
  
  # ä¿®æ­£æ¨ªçº¿è®¾ç½® - ä½¿ç”¨ä¸€è‡´çš„è¯­æ³•
  hrzl_lines <- list()
  hrzl_lines[["1"]] <- gpar(lty = 1, lwd = 2)  # é¡¶éƒ¨çº¿ï¼ˆè¡¨å¤´ä¸Šæ–¹ï¼‰
  hrzl_lines[["2"]] <- gpar(lty = 1, lwd = 2)  # é¡¶éƒ¨çº¿ï¼ˆè¡¨å¤´ä¸‹æ–¹ï¼‰
  hrzl_lines[[as.character(nrow(forest_data)+1)]] <- gpar(lty = 1, lwd = 2)  # åº•éƒ¨çº¿ï¼ˆæœ€åä¸€è¡Œä¸‹æ–¹ï¼‰
  
  # å®šåˆ¶æ ‡é¢˜ - æ ¹æ®testcd
  title_text <- switch(current_testcd,
                       "ICU28D" = "28-day all-cause mortality",
                       "ICUXXD" = "ICU mortality",
                       "HOSPXXD" = "In-hospital mortality",
                       "OTHER" = "Other Outcome",
                       paste("Forest Plot for", current_testcd))  # é»˜è®¤å€¼
  
  # ç»˜åˆ¶ä¸“ä¸šæ£®æ—å›¾
  p <- forestplot(
    labeltext = label_matrix,
    mean = mean_vals,
    lower = lower_vals,
    upper = upper_vals,
    is.summary = summary_vector,
    zero = 1,
    boxsize = 0.2,
    lineheight = unit(10, "mm"),
    colgap = unit(4, "mm"),
    graphwidth = unit(100, "mm"),
    line.margin = unit(1, "mm"),
    col = fpColors(
      box = "#1F497D",    # æ–¹æ¡†è‰²ï¼šä¸“ä¸šè“
      lines = "#1F497D",  # è¿æ¥çº¿è‰²ï¼šæ£®æ—ç»¿
      zero = "black",   # æ— æ•ˆçº¿è‰²ï¼šé†’ç›®çº¢
      summary = "#8064A2" # æ±‡æ€»è¡Œè‰²ï¼šå…¸é›…ç´«
    ),
    xlab = "Hazard Ratio",
    txt_gp = fpTxtGp(
      label = gpar(cex = 0.9),
      ticks = gpar(cex = 0.8),
      xlab = gpar(cex = 1.0),
      title = gpar(cex = 1.2),
      summary = list (gpar(fontface = "bold"),
                      gpar(fill = "gray", col = "gray", lwd = 10)
      )# äºšç»„æ ‡é¢˜åŠ ç²—
    ),
    title = title_text,  # ä½¿ç”¨å®šåˆ¶æ ‡é¢˜
    graph.pos = 6,  # å°†å›¾å½¢æ”¾åœ¨å€’æ•°ç¬¬äºŒåˆ—
    hrzl_lines = hrzl_lines,
    clip = c(x_min, x_max),
    lwd.zero = 1.5,
    lwd.ci = 1.5,
    lwd.xaxis = 1.5,
    grid = TRUE,
    xticks = x_ticks,
    ci.vertices = TRUE,
    ci.vertices.height = 0.15
  ) |> fp_set_zebra_style("#EFEFEF", ignore_subheaders = TRUE)
  
  # åˆ›å»ºè¾“å‡ºç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
  if (!dir.exists("forestplot_output")) {
    dir.create("forestplot_output")
  }
  
  # è®¾ç½®å›¾åƒå°ºå¯¸
  width_inch <- 15
  height_inch <- 11.25
  
  # ä¿å­˜ä¸ºå››ç§æ ¼å¼
  base_filename <- paste0("forestplot_output/filab_", current_testcd, "_forestplot")
  
  # PNGæ ¼å¼
  png_filename <- paste0(base_filename, ".png")
  png(png_filename, width = width_inch, height = height_inch, units = "in", res = 300)
  print(p)
  dev.off()
  
  # SVGæ ¼å¼
  svg_filename <- paste0(base_filename, ".svg")
  svg(svg_filename, width = width_inch, height = height_inch)
  print(p)
  dev.off()
  
  # JPGæ ¼å¼
  jpg_filename <- paste0(base_filename, ".jpg")
  jpeg(jpg_filename, width = width_inch, height = height_inch, units = "in", res = 300, quality = 100)
  print(p)
  dev.off()
  
  # TIFFæ ¼å¼
  tif_filename <- paste0(base_filename, ".tif")
  tiff(tif_filename, width = width_inch, height = height_inch, units = "in", res = 300, compression = "lzw")
  print(p)
  dev.off()
  
  message(paste("æ£®æ—å›¾å·²ä¿å­˜:", png_filename, svg_filename, jpg_filename, tif_filename))
}


```

### 2.ä½¿ç”¨åˆ†ç±»å˜é‡ç»˜å›¾: å‚è€ƒæ ·å¼

![](https://jintensivecare.biomedcentral.com/articles/10.1186/s40560-025-00797-9/figures/3)

```{r}
# æ›´æ–°ä»£ç  - æ›¿æ¢ä¸ºå››åˆ†ç±»levelå˜é‡
if(!require(forestplot)) install.packages("forestplot")
if(!require(survival)) install.packages("survival")
if(!require(dplyr)) install.packages("dplyr")
if(!require(tidyr)) install.packages("tidyr")
library(forestplot)
library(survival)
library(dplyr)
library(tidyr)

# å®šä¹‰è¦åˆ†æçš„testcdåˆ—è¡¨ - æŒ‰éœ€ä¿®æ”¹
testcd_list <- c("ICU28D", "HOSPXXD")  # æ›¿æ¢ä¸ºæ‚¨çš„ä¸‰ä¸ªtestcdå€¼

# éå†æ¯ä¸ªtestcdç”Ÿæˆæ£®æ—å›¾
for (current_testcd in testcd_list) {
  # è¯»å–æ•°æ®
  # ç­›é€‰ç‰¹å®štestcd
  data <- tte %>% 
    filter(testcd == current_testcd)  # æ ¹æ®éœ€æ±‚ä¿®æ”¹
  
  # ç¡®ä¿levelæ˜¯å› å­å˜é‡ï¼Œè®¾ç½®å‚è€ƒæ°´å¹³ï¼ˆQ1ä½œä¸ºå‚è€ƒï¼‰
  data$level <- factor(data$level, levels = c("Q1", "Q2", "Q3", "Q4"))
  
  # ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„åå˜é‡å’Œäºšç»„å˜é‡ - æ ¹æ®æ‚¨çš„å®é™…è®¾ç½®
  covariates_m2 <- metadata$variable_name[metadata$covars_m2 == 1]
  subgroup_vars <- metadata$variable_name[metadata$subgroup == 1]
  
  # ç¡®ä¿æ—¶é—´å’Œäº‹ä»¶å˜é‡æ˜¯æ•°å€¼å‹
  data$time <- as.numeric(data$aval)
  data$event <- as.numeric(data$cnsr)
  
  # å­˜å‚¨äºšç»„åˆ†æç»“æœ
  subgroup_results <- list()
  interaction_p_values <- list()
  
  # å¯¹æ¯ä¸ªäºšç»„å˜é‡è¿›è¡Œåˆ†æ
  for (var_name in subgroup_vars) {
    # è·å–å˜é‡ç±»åˆ«
    if (is.numeric(data[[var_name]])) {
      # æ•°å€¼å˜é‡è½¬æ¢ä¸ºäºŒåˆ†å˜é‡
      median_val <- median(data[[var_name]], na.rm = TRUE)
      var_categories <- c(paste0("â‰¤", median_val), paste0(">", median_val))
    } else {
      var_categories <- sort(unique(na.omit(data[[var_name]])))
    }
    
    results_for_var <- list()
    
    # å¯¹è¯¥å˜é‡çš„æ¯ä¸ªç±»åˆ«è¿›è¡Œäºšç»„åˆ†æ
    for (category in var_categories) {
      if (is.numeric(data[[var_name]])) {
        # æ•°å€¼å˜é‡çš„ç‰¹æ®Šå¤„ç†
        if (grepl("â‰¤", category)) {
          cutoff <- as.numeric(gsub("â‰¤", "", category))
          subset_data <- data[data[[var_name]] <= cutoff, ]
        } else {
          cutoff <- as.numeric(gsub(">", "", category))
          subset_data <- data[data[[var_name]] > cutoff, ]
        }
      } else {
        subset_data <- data[data[[var_name]] == category, ]
      }
      
      # è®¡ç®—æ€»äººæ•°å’Œäº‹ä»¶æ•°ï¼ˆç™¾åˆ†æ¯”ï¼‰
      total_n <- nrow(subset_data)
      
      # åœ¨å­é›†ä¸Šæ‹ŸåˆCoxæ¨¡å‹
      tryCatch({
        # æ„å»ºåå˜é‡å…¬å¼
        cov_formula <- if (length(covariates_m2) > 0) {
          paste(covariates_m2, collapse = " + ")
        } else {
          "1"
        }
        
        model_formula <- as.formula(paste("Surv(time, event) ~ level +", cov_formula))
        model <- coxph(model_formula, data = subset_data)
        
        # æå–ç»“æœ
        summary_result <- summary(model)
        coefs <- summary_result$coefficients
        
        # ä¸ºæ¯ä¸ªlevelåˆ›å»ºç»“æœè¡Œ (Q1-Q4)
        for (lev in levels(data$level)) {
          # è·³è¿‡å‚è€ƒæ°´å¹³Q1ï¼ˆä½œä¸ºå‚ç…§ï¼‰
          if (lev == "Q1") {
            # ä¸ºQ1åˆ›å»ºå‚ç…§è¡Œ
            event_n <- sum(subset_data$event[subset_data$level == lev] == 1, na.rm = TRUE)
            event_percent <- round(event_n / sum(subset_data$level == lev, na.rm = TRUE) * 100, 1)
            event_str <- sprintf("%d (%0.1f%%)", event_n, event_percent)
            
            results_for_var[[paste0(category, "_", lev)]] <- data.frame(
              Subgroup = var_name,
              Category = category,
              Level = lev,
              Total = sum(subset_data$level == lev, na.rm = TRUE),
              Event = event_str,
              HR = 1.0,  # å‚è€ƒæ°´å¹³HR=1
              Lower_CI = NA,
              Upper_CI = NA,
              P_value = NA,
              stringsAsFactors = FALSE
            )
          } else {
            # æå–éå‚è€ƒæ°´å¹³çš„ç»“æœ
            row_name <- paste0("level", lev)
            exposure_row <- which(rownames(coefs) == row_name)
            
            if (length(exposure_row) > 0) {
              event_n <- sum(subset_data$event[subset_data$level == lev] == 1, na.rm = TRUE)
              event_percent <- round(event_n / sum(subset_data$level == lev, na.rm = TRUE) * 100, 1)
              event_str <- sprintf("%d (%0.1f%%)", event_n, event_percent)
              
              hr <- exp(coefs[exposure_row, "coef"])
              lower_ci <- exp(coefs[exposure_row, "coef"] - 1.96 * coefs[exposure_row, "se(coef)"])
              upper_ci <- exp(coefs[exposure_row, "coef"] + 1.96 * coefs[exposure_row, "se(coef)"])
              p_value <- coefs[exposure_row, "Pr(>|z|)"]  # æå–På€¼
              
              # ä¿å­˜ç»“æœ
              results_for_var[[paste0(category, "_", lev)]] <- data.frame(
                Subgroup = var_name,
                Category = category,
                Level = lev,
                Total = sum(subset_data$level == lev, na.rm = TRUE),
                Event = event_str,
                HR = hr,
                Lower_CI = lower_ci,
                Upper_CI = upper_ci,
                P_value = p_value,
                stringsAsFactors = FALSE
              )
            }
          }
        }
      }, error = function(e) {
        message(paste("Error in subgroup", var_name, "-", category, ":", e$message))
      })
    }
    
    # åˆå¹¶è¯¥å˜é‡çš„æ‰€æœ‰ç±»åˆ«ç»“æœ
    if (length(results_for_var) > 0) {
      var_df <- do.call(rbind, results_for_var)
      subgroup_results[[var_name]] <- var_df
      
      # è®¡ç®—äº¤äº’På€¼ï¼ˆä½¿ç”¨ä¼¼ç„¶æ¯”æ£€éªŒï¼‰
      reduced_formula <- as.formula(
        paste("Surv(time, event) ~ level +", var_name, "+", 
              paste(covariates_m2, collapse = " + "))
      )
      
      full_formula <- as.formula(
        paste("Surv(time, event) ~ level *", var_name, "+", 
              paste(covariates_m2, collapse = " + "))
      )
      
      reduced_model <- tryCatch({
        coxph(reduced_formula, data = data)
      }, error = function(e) {
        return(NULL)
      })
      
      full_model <- tryCatch({
        coxph(full_formula, data = data)
      }, error = function(e) {
        return(NULL)
      })
      
      if (!is.null(reduced_model) && !is.null(full_model)) {
        lrt <- anova(reduced_model, full_model)
        interaction_p <- lrt[2, "Pr(>|Chi|)"]
        
        interaction_p_values[[var_name]] <- data.frame(
          Subgroup = var_name,
          P_interaction = interaction_p
        )
      }
    }
  }
  
  # åˆå¹¶æ‰€æœ‰äºšç»„ç»“æœ
  all_subgroups_results <- if (length(subgroup_results) > 0) {
    do.call(rbind, subgroup_results)
  } else {
    data.frame()
  }
  
  # æ·»åŠ Overallè¡Œ - æ€»ä½“æ•ˆåº”
  tryCatch({
    # æ„å»ºåå˜é‡å…¬å¼
    cov_formula <- if (length(covariates_m2) > 0) {
      paste(covariates_m2, collapse = " + ")
    } else {
      "1"
    }
    
    model_formula <- as.formula(paste("Surv(time, event) ~ level +", cov_formula))
    overall_model <- coxph(model_formula, data = data)
    
    # æå–ç»“æœ
    summary_result <- summary(overall_model)
    coefs <- summary_result$coefficients
    
    # ä¸ºæ¯ä¸ªlevelåˆ›å»ºç»“æœè¡Œ (Q1-Q4)
    overall_results <- list()
    for (lev in levels(data$level)) {
      if (lev == "Q1") {
        # ä¸ºQ1åˆ›å»ºå‚ç…§è¡Œ
        event_n <- sum(data$event[data$level == lev] == 1, na.rm = TRUE)
        event_percent <- round(event_n / sum(data$level == lev, na.rm = TRUE) * 100, 1)
        event_str <- sprintf("%d (%0.1f%%)", event_n, event_percent)
        
        overall_results[[lev]] <- data.frame(
          Subgroup = "Overall",
          Category = "Overall",
          Level = lev,
          Total = sum(data$level == lev, na.rm = TRUE),
          Event = event_str,
          HR = 1.0,  # å‚è€ƒæ°´å¹³HR=1
          Lower_CI = NA,
          Upper_CI = NA,
          P_value = NA,
          stringsAsFactors = FALSE
        )
      } else {
        # æå–éå‚è€ƒæ°´å¹³çš„ç»“æœ
        row_name <- paste0("level", lev)
        exposure_row <- which(rownames(coefs) == row_name)
        
        if (length(exposure_row) > 0) {
          event_n <- sum(data$event[data$level == lev] == 1, na.rm = TRUE)
          event_percent <- round(event_n / sum(data$level == lev, na.rm = TRUE) * 100, 1)
          event_str <- sprintf("%d (%0.1f%%)", event_n, event_percent)
          
          hr <- exp(coefs[exposure_row, "coef"])
          lower_ci <- exp(coefs[exposure_row, "coef"] - 1.96 * coefs[exposure_row, "se(coef)"])
          upper_ci <- exp(coefs[exposure_row, "coef"] + 1.96 * coefs[exposure_row, "se(coef)"])
          p_value <- coefs[exposure_row, "Pr(>|z|)"]  # æå–På€¼
          
          # ä¿å­˜ç»“æœ
          overall_results[[lev]] <- data.frame(
            Subgroup = "Overall",
            Category = "Overall",
            Level = lev,
            Total = sum(data$level == lev, na.rm = TRUE),
            Event = event_str,
            HR = hr,
            Lower_CI = lower_ci,
            Upper_CI = upper_ci,
            P_value = p_value,
            stringsAsFactors = FALSE
          )
        }
      }
    }
    
    # å°†Overallè¡Œæ·»åŠ åˆ°ç»“æœé¡¶éƒ¨
    if (length(overall_results) > 0) {
      overall_df <- do.call(rbind, overall_results)
      all_subgroups_results <- bind_rows(overall_df, all_subgroups_results)
    }
  }, error = function(e) {
    message(paste("Error in overall model:", e$message))
  })
  
  # åˆå¹¶äº¤äº’ä½œç”¨På€¼
  if (length(interaction_p_values) > 0) {
    interaction_df <- do.call(rbind, interaction_p_values)
    all_subgroups_results <- all_subgroups_results %>%
      left_join(interaction_df, by = "Subgroup")
  } else {
    all_subgroups_results$P_interaction <- NA
  }
  
  # ä½¿ç”¨metadataä¸­çš„æ ‡ç­¾æ›¿æ¢å˜é‡å
  if (!is.null(metadata) && "label" %in% colnames(metadata)) {
    # åˆ›å»ºä»å˜é‡ååˆ°æ ‡ç­¾çš„æ˜ å°„
    label_mapping <- setNames(metadata$label, metadata$variable_name)
    # æ·»åŠ Overallçš„æ˜ å°„
    label_mapping["Overall"] <- "Overall"
    
    # æ›¿æ¢Subgroupåˆ—
    all_subgroups_results$Subgroup <- ifelse(
      all_subgroups_results$Subgroup %in% names(label_mapping),
      label_mapping[all_subgroups_results$Subgroup],
      all_subgroups_results$Subgroup
    )
  }
  
  # è½¬æ¢Categoryæ˜¾ç¤º
  all_subgroups_results <- all_subgroups_results %>%
    mutate(
      Category = case_when(
        Subgroup !="AKI stage" & Category == "0" ~ "No",
        Subgroup !="AKI stage" & Category == "1" ~ "Yes",
        Category == "F" ~ "Female",
        Category == "M" ~ "Male",
        TRUE ~ as.character(Category)
      )
    )
  
  # æ ¼å¼åŒ–æ•°æ®ç”¨äºæ£®æ—å›¾
  if (nrow(all_subgroups_results) == 0) {
    stop("äºšç»„åˆ†ææœªç”Ÿæˆä»»ä½•ç»“æœï¼Œè¯·æ£€æŸ¥æ•°æ®ã€äºšç»„å˜é‡å’Œæ¨¡å‹å…¬å¼")
  }
  
  # åˆ›å»ºä¸“ä¸šåŒ»å­¦æœŸåˆŠé£æ ¼çš„æ£®æ—å›¾æ•°æ®
  # ä»metadataä¸­æå–æ’åºé¡ºåº
  if (!is.null(metadata) && "order" %in% colnames(metadata)) {
    # åˆ›å»ºæ’åºæ˜ å°„
    order_mapping <- setNames(metadata$order[metadata$subgroup==1], metadata$label[metadata$subgroup==1])
    # æ·»åŠ Overallçš„æ’åºï¼ˆè®¾ä¸º0ï¼‰
    order_mapping <- c(order_mapping, setNames(0, "Overall"))
  } else {
    # å¦‚æœmetadataä¸­æ²¡æœ‰orderåˆ—ï¼Œåˆ›å»ºé»˜è®¤æ’åº
    unique_subgroups <- setdiff(unique(all_subgroups_results$Subgroup), "Overall")
    order_mapping <- setNames(1:length(unique_subgroups), unique_subgroups)
    order_mapping["Overall"] <- 0
  }
  
  # å°†æ’åºé¡ºåºåº”ç”¨åˆ°æ•°æ®
  all_subgroups_results <- all_subgroups_results %>%
    mutate(
      Order = order_mapping[Subgroup],
      # ç¡®ä¿Overallæ’åœ¨æœ€å‰é¢
      Order = ifelse(Subgroup == "Overall", 0, Order)
    ) %>%
    arrange(Order, Subgroup, Category, Level)
  
  # æå–Subgroup label,ä¸ºæ¥ä¸‹æ¥æ‹¼æ¥åšå‡†å¤‡
  Group_Header <- all_subgroups_results %>%
    filter(Subgroup != "Overall") %>%
    distinct(Order, Subgroup, P_interaction) %>%
    select(Order, Subgroup, P_interaction)
  
  # åˆ›å»ºæ£®æ—å›¾æ•°æ®
  
  forest_data <- all_subgroups_results %>% 
    bind_rows(Group_Header) %>%
    arrange(Order, Subgroup, desc(is.na(Category)), Category, Level) %>%
    mutate(
      HR_CI = ifelse(Level == "Q1", "1 (Ref)", 
                     sprintf("%.2f (%.2f-%.2f)", HR, Lower_CI, Upper_CI)),
      P_value_str = ifelse(is.na(P_value), "", 
                           ifelse(P_value < 0.001, "<0.001", sprintf("%.3f", P_value))),
      P_interaction = ifelse(is.na(P_interaction), "", 
                             ifelse(P_interaction < 0.001, "<0.001", sprintf("%.3f", P_interaction))),
      P_interaction = ifelse(!duplicated(Subgroup), P_interaction, "")
    ) %>%
    
    group_by(Subgroup, Category) %>%
    mutate(
      Group_Header = case_when(
        Subgroup == "Overall" ~ ifelse(row_number() == 1, as.character(Subgroup), ""),
        !is.na(Category) & Category != "Overall" ~ ifelse(row_number() == 1,paste0("  ", Category),""),
        TRUE ~ Subgroup
      )
      
    ) %>%  ungroup() %>%
    select(Group_Header, Level, Total, Event, HR, Lower_CI, Upper_CI, P_value_str, HR_CI, P_interaction) %>%
    relocate(Group_Header, Level, Total, Event, HR_CI, P_value_str, P_interaction)
  
  # ä¿®å¤ç±»å‹ä¸åŒ¹é…é—®é¢˜
  forest_data <- forest_data %>%
    mutate(
      Total = ifelse(is.na(Total), "", as.character(Total)),
      Event = ifelse(is.na(Event), "", as.character(Event)),
      P_value_str = ifelse(is.na(P_value_str), "", P_value_str)
    )
  
  # æ·»åŠ è¡¨å¤´è¡Œ - åŒ…å«På€¼åˆ—
  header <- data.frame(
    Group_Header = "Subgroup",
    Level="Level",
    Total = "Total n",
    Event = "Event n (%)",
    HR_CI = "HR (95% CI)",
    P_value_str = "P value",
    P_interaction = "P for interaction",
    stringsAsFactors = FALSE
  )
  
  # åˆå¹¶æ•°æ®ï¼ˆè¡¨å¤´åœ¨æœ€å‰é¢ï¼‰
  forest_data <- bind_rows(header, forest_data)
  
  # åˆ›å»ºæ ‡è¯†æ±‡æ€»è¡Œï¼ˆéœ€è¦åŠ ç²—çš„è¡Œï¼‰çš„é€»è¾‘å‘é‡
  summary_vector <- rep(FALSE, nrow(forest_data))
  
  # è¡¨å¤´è¡Œï¼ˆç¬¬ä¸€è¡Œï¼‰éœ€è¦åŠ ç²—
  summary_vector[1] <- TRUE
  for (i in 2:nrow(forest_data)) {
    # è·å–å½“å‰è¡Œçš„Group_Headerå†…å®¹
    current_header <- forest_data$Group_Header[i]
    
    # è¯†åˆ«Overallè¡Œ
    if (current_header == "Overall") {
      summary_vector[i] <- TRUE
    }
    # è¯†åˆ«äºšç»„æ ‡é¢˜è¡Œ - é€šè¿‡æ£€æŸ¥æ˜¯å¦æ˜¯æœªç¼©è¿›çš„æ ‡é¢˜
    else if (!startsWith(current_header, "    ") && current_header != "") {
      summary_vector[i] <- TRUE
    }
  }
  
  # åˆ›å»ºä¸forest_dataè¡Œæ•°åŒ¹é…çš„HRæ•°æ®å‘é‡
  mean_vals <- rep(NA, nrow(forest_data))
  lower_vals <- rep(NA, nrow(forest_data))
  upper_vals <- rep(NA, nrow(forest_data))
  
  # æ‰¾å‡ºå®é™…æœ‰HRæ•°æ®çš„è¡Œ
  category_rows <- which(!is.na(forest_data$HR))
  
  # å¡«å……HRæ•°æ®
  if (length(category_rows) > 0 && nrow(forest_data) > 0) {
    mean_vals[category_rows] <- forest_data$HR[category_rows]
    lower_vals[category_rows] <- forest_data$Lower_CI[category_rows]
    upper_vals[category_rows] <- forest_data$Upper_CI[category_rows]
  }
  
  # åˆ›å»ºæ–‡æœ¬çŸ©é˜µ - åŒ…å«På€¼åˆ—
  label_matrix <- as.matrix(forest_data[, c("Group_Header", "Level", "Total", "Event", "HR_CI", "P_value_str",  "P_interaction")])
  
  # ç¡®å®šåˆé€‚çš„xè½´èŒƒå›´
  all_hr_vals <- na.omit(c(all_subgroups_results$Lower_CI, all_subgroups_results$Upper_CI))
  if (length(all_hr_vals) > 0) {
    x_min <- min(0.5, floor(min(all_hr_vals)*10)/10)
    x_max <- max(2.5, ceiling(max(all_hr_vals)*10)/10)
    x_ticks <- seq(x_min, x_max, length.out = 5)
  } else {
    x_min <- 0.5
    x_max <- 2.0
    x_ticks <- c(0.5, 1.0, 1.5, 2.0)
  }
  
  # ä¿®æ­£æ¨ªçº¿è®¾ç½®
  hrzl_lines <- list()
  hrzl_lines[["1"]] <- gpar(lty = 1, lwd = 2)
  hrzl_lines[["2"]] <- gpar(lty = 1, lwd = 2)
  hrzl_lines[[as.character(nrow(forest_data)+1)]] <- gpar(lty = 1, lwd = 2)
  
  # å®šåˆ¶æ ‡é¢˜ - æ ¹æ®testcd
  title_text <- switch(current_testcd,
                       "ICU28D" = "28-Day ICU Mortality",
                       "ICUXXD" = "ICU Mortality",
                       "HOSPXXD" = "In-Hospital Mortality",
                       "OTHER" = "Other Outcome",
                       paste("Forest Plot for", current_testcd))
  
  # ç»˜åˆ¶ä¸“ä¸šæ£®æ—å›¾
  p <- forestplot(
    labeltext = label_matrix,
    mean = mean_vals,
    lower = lower_vals,
    upper = upper_vals,
    is.summary = summary_vector,
    zero = 1,
    boxsize = 0.2,
    lineheight = unit(10, "mm"),
    colgap = unit(4, "mm"),
    graphwidth = unit(100, "mm"),
    line.margin = unit(2, "mm"),
    margin = unit(rep(10, 4), "mm"),
    col = fpColors(
      box = "#1F497D",
      lines = "#1F497D",
      zero = "black",
      summary = "#8064A2"
    ),
    xlab = "Hazard Ratio",
    txt_gp = fpTxtGp(
      label = gpar(cex = 0.9),
      ticks = gpar(cex = 0.8),
      xlab = gpar(cex = 1.0),
      title = gpar(cex = 1.2),
      summary = list(
        gpar(fontface = "bold"),
        gpar(fill = "gray", col = "gray", lwd = 10)
      )
    ),
    title = title_text,
    graph.pos = 7,
    hrzl_lines = hrzl_lines,
    clip = c(x_min, x_max),
    lwd.zero = 1.5,
    lwd.ci = 1.5,
    lwd.xaxis = 1.5,
    grid = TRUE,
    xticks = x_ticks,
    ci.vertices = TRUE,
    ci.vertices.height = 0.15
  ) |> fp_set_zebra_style("#EFEFEF", ignore_subheaders = TRUE)
  
  # åˆ›å»ºè¾“å‡ºç›®å½•
  if (!dir.exists("forestplot_output")) {
    dir.create("forestplot_output")
  }
  
  # è®¾ç½®å›¾åƒå°ºå¯¸
  width_inch <- 28
  height_inch <- 20
  
  # ä¿å­˜ä¸ºå››ç§æ ¼å¼
  base_filename <- paste0("forestplot_output/Qlevel_", current_testcd, "_forestplot")
  
  # PNGæ ¼å¼
  png(paste0(base_filename, ".png"), width = 12, height = 20, units = "in", res = 300)
  print(p)
  dev.off()
  
  # SVGæ ¼å¼
  svg(paste0(base_filename, ".svg"), width = width_inch, height = height_inch)
  print(p)
  dev.off()
  
  # JPGæ ¼å¼
  jpeg(paste0(base_filename, ".jpg"), width = 12, height = 20, units = "in", res = 300, quality = 100)
  print(p)
  dev.off()
  
  # TIFFæ ¼å¼
  tiff(paste0(base_filename, ".tif"), width = width_inch, height = height_inch, units = "in", res = 300, compression = "lzw")
  print(p)
  dev.off()
  
  message(paste("æ£®æ—å›¾å·²ä¿å­˜:", base_filename))
}


```

```         
```

## **FI-Labå¢é‡æ•ˆåº”: å¤šæ¨¡å‹AUCåŠæ£€éªŒ+DCA/C-index/NRIè®¡ç®—**

### Table 4 Improvement in discrimination and risk reclassification for xx mortality after addition of FI-Lab

```{r}
# åŒ…ç®¡ç†ï¼šè‡ªåŠ¨å®‰è£…ç¼ºå¤±çš„åŒ…
required_packages <- c("rms", "Hmisc", "survIDINRI", "purrr", "stringr","officer", "flextable", "dplyr")
missing_packages <- setdiff(required_packages, rownames(installed.packages()))
if(length(missing_packages) > 0) install.packages(missing_packages)
invisible(lapply(required_packages, library, character.only = TRUE))

# è®¾ç½®å…¨å±€ç§å­ç¡®ä¿å¯å¤ç°æ€§
set.seed(123)

# # é…ç½®å‚æ•°
# time_point <- 28  # ICU28Dæ—¶é—´ç‚¹
# scores <- c("apsiii", "sapsii", "oasis", "sofa", "sirs", "gcs")  # æ‰€æœ‰è¯„åˆ†ç³»ç»Ÿ
# prediction_var <- "flab100"

# ä¸»åˆ†æå‡½æ•°
analyze_models <- function(score, data,time_point) {
  # 1. æ„å»ºæ¨¡å‹å…¬å¼
  original_formula <- as.formula(paste("Surv(time, event) ~", score))
  enhanced_formula <- as.formula(paste("Surv(time, event) ~", score, "+", prediction_var))
  
  # 2. é…ç½®æ•°æ®ç¯å¢ƒ
  ddist <- datadist(data)
  options(datadist = ddist)
  
  # 3. æ‹Ÿåˆæ¨¡å‹
  original_model <- cph(original_formula, data = data, x = TRUE, y = TRUE, surv = TRUE, time.inc = time_point)
  enhanced_model <- cph(enhanced_formula, data = data, x = TRUE, y = TRUE, surv = TRUE, time.inc = time_point)
  
  # 4. ä¿®æ­£C-indexè®¡ç®—ï¼šä½¿ç”¨0.5 + abs(dxy)/2
  calc_cindex <- function(model) {
    pred <- predict(model, type = "lp")
    dxy_obj <- rcorr.cens(pred, Surv(data$time, data$event))
    dxy <- dxy_obj["Dxy"]
    est <- 0.5 + abs(dxy)/2  # ä¿®æ­£åçš„C-indexè®¡ç®—
    se <- dxy_obj["S.D."] / 2
    list(
      est = est,
      lower = max(0.5, est - 1.96 * se),  # ç¡®ä¿ä¸ä½äº0.5
      upper = min(1.0, est + 1.96 * se)   # ç¡®ä¿ä¸é«˜äº1.0
    )
  }
  
  cindex_orig <- calc_cindex(original_model)
  cindex_enh <- calc_cindex(enhanced_model)
  
  # 5. å‡†å¤‡åå˜é‡çŸ©é˜µ
  covs0_matrix <- as.matrix(data[[score]])
  covs1_matrix <- as.matrix(data[, c(score, "flab100")])
  indat_matrix <- as.matrix(data[, c("time", "event")])
  
  # 6. è®¡ç®—IDIå’Œè¿ç»­NRI
  IDI_NRI_results <- IDI.INF(
    indata = indat_matrix,
    covs0 = covs0_matrix,
    covs1 = covs1_matrix,
    t0 = time_point,
    npert = 500
  )
  
  # 7. æå–ç»“æœ
  list(
    original = list(
      score = score,
      cindex = cindex_orig,
      label = paste0(toupper(score))
    ),
    enhanced = list(
      score = score,
      cindex = cindex_enh,
      IDI = c(
        est = IDI_NRI_results$m1[1] * 100,
        lower = IDI_NRI_results$m1[2] * 100,
        upper = IDI_NRI_results$m1[3] * 100
      ),
      NRI = c(
        est = IDI_NRI_results$m2[1] * 100,
        lower = IDI_NRI_results$m2[2] * 100,
        upper = IDI_NRI_results$m2[3] * 100
      ),
      IDI_pvalue = IDI_NRI_results$m1[4],
      NRI_pvalue = IDI_NRI_results$m2[4],
      label = paste0(toupper(score), " + FI-Lab")
    )
  )
}

# æ•°æ®å¤„ç†å’Œåˆ†æä¸»å‡½æ•°
analyze_and_generate <- function(testcd, time_point) {
  # é…ç½®å‚æ•°
  scores <- c("apsiii", "sapsii", "oasis", "sofa", "sirs", "gcs")
  prediction_var <- "flab100"
  
  # æ•°æ®å¤„ç†
  analysis_data <- tte %>%
    filter(testcd == !!testcd) %>%  # åŠ¨æ€è¿‡æ»¤
    select(-any_of(c("Q1", "Q2", "Q3", "Q4"))) %>%
    mutate(flab100 = as.numeric(flab100)) %>% 
    filter(!is.na(flab100)) %>%
    mutate(time = as.numeric(aval),
           event = as.numeric(cnsr))
  
  # æ‰§è¡Œåˆ†æ
  results <- map(scores, ~ analyze_models(.x, analysis_data, time_point)) %>%
    map(~ list(original = .x$original, enhanced = .x$enhanced)) %>%
    flatten()
  
  # ç”Ÿæˆç»“æœè¡¨æ ¼
  results_df <- map_dfr(results, function(res) {
    if ("IDI" %in% names(res)) {
      data.frame(
        Model = res$label,
        C_index = sprintf("%.3f (%.3f, %.3f)", res$cindex$est, res$cindex$lower, res$cindex$upper),
        IDI = sprintf("%.2f%% (%.2f%%, %.2f%%)", res$IDI[1], res$IDI[2], res$IDI[3]),
        IDI_pvalue = ifelse(res$IDI_pvalue < 0.001, "< 0.001", sprintf("%.3f", res$IDI_pvalue)),
        NRI = sprintf("%.2f%% (%.2f%%, %.2f%%)", res$NRI[1], res$NRI[2], res$NRI[3]),
        NRI_pvalue = ifelse(res$NRI_pvalue < 0.001, "< 0.001", sprintf("%.3f", res$NRI_pvalue))
      )
    } else {
      data.frame(
        Model = res$label,
        C_index = sprintf("%.3f (%.3f, %.3f)", res$cindex$est, res$cindex$lower, res$cindex$upper),
        IDI = "Ref",
        IDI_pvalue = "Ref",
        NRI = "Ref",
        NRI_pvalue = "Ref"
      )
    }
  })
  
  # ç”Ÿæˆè¡¨æ ¼å¹¶è¿”å›æ–‡ä»¶å
  generate_table(testcd, results_df)
}

# ç”Ÿæˆè¡¨æ ¼å‡½æ•°
generate_table <- function(testcd, results) {
# æ™ºèƒ½æ ‡é¢˜ç”Ÿæˆ
title <- ifelse(str_detect(testcd, "HOSP"), "In-hospital mortality",
                  ifelse(str_detect(testcd, "ICU"), 
                         paste0(str_extract(testcd, "\\d+"), "-day all-cause mortality"),
                         paste(testcd, "Mortality")))

# åˆ›å»ºä¸“ä¸šä¸‰çº¿è¡¨
ft <- flextable(results) %>%
  # è®¾ç½®è¡¨æ ¼æ ‡é¢˜
  set_caption(caption = paste0("Table 4 Improvement in discrimination and risk reclassification for ",title, " after addition of FI-Lab"),
              style = "Table Caption") %>% 
  font(fontname = "Times New Roman", part = "all") %>%  # å­¦æœ¯å­—ä½“
  set_header_labels(
    Model = "Model",
    C_index = "C-index (95% CI)",
    IDI = "IDI, % (95% CI)",
    IDI_pvalue = "IDI P-value",
    NRI = "NRI, % (95% CI)",
    NRI_pvalue = "NRI P-value"
  ) %>%
  theme_booktabs() %>%  # ä¸‰çº¿è¡¨æ ·å¼
  autofit() %>%         # è‡ªåŠ¨é€‚åº”åˆ—å®½
  align(align = "center", part = "all") %>%  # å†…å®¹å±…ä¸­
  fontsize(size = 10, part = "all") %>%      # å­—ä½“å¤§å°
  bold(part = "header") %>%                  # è¡¨å¤´åŠ ç²—
  padding(padding = 3, part = "all")         # å•å…ƒæ ¼å†…è¾¹è·


# ä¿å­˜ä¸ºWordæ–‡æ¡£
save_as_docx(ft, 
             path = paste0("Table 4-", testcd,".docx"), 
             pr_section = prop_section(page_size = page_size(orient = "landscape")))

}

# æ‰§è¡Œåˆ†æå¹¶ç”Ÿæˆè¡¨æ ¼
# ICU28Dåˆ†æï¼ˆTable 4ï¼‰
icu_file <- analyze_and_generate(
  testcd = "ICU28D", 
  time_point = 28
)

# HOSPXXDåˆ†æï¼ˆTable 4ï¼‰
hosp_file <- analyze_and_generate(
  testcd = "HOSPXXD", 
  time_point = 28  # ä¹Ÿè®¾HOSPXXDæ—¶é—´ç‚¹ä¸º28å¤©
)

# è¾“å‡ºç»“æœ
message(sprintf("ç”Ÿæˆå®Œæˆ: \n1. %s\n2. %s", icu_file, hosp_file))

```

### Figure 5 ROC curve analysis of the incremental effect of FI-Lab on in-hospital all-cause mortality

```{r}
# å®‰è£…å¹¶åŠ è½½æ‰€éœ€åŒ…
required_packages <- c("rms", "Hmisc", "survIDINRI", "timeROC", "ggplot2", "pROC", 
                       "purrr", "stringr", "dplyr", "gridExtra", "RColorBrewer", "grid","future")
missing_packages <- setdiff(required_packages, rownames(installed.packages()))
if(length(missing_packages) > 0) install.packages(missing_packages)
invisible(lapply(required_packages, library, character.only = TRUE))

# è®¾ç½®å…¨å±€ç§å­ç¡®ä¿å¯å¤ç°æ€§
set.seed(123)

# å¢å¼ºç‰ˆROCæ›²çº¿ç»˜åˆ¶å‡½æ•°
generate_roc_plots <- function(testcd, time_point, scores, data) {
  # æ ¹æ®testcdç”Ÿæˆæ ‡é¢˜
  title_text <- ifelse(
    grepl("ICU", testcd),
    paste0(
      "ROC curve analysis of the incremental effect of FI-Lab on ",
      ifelse(
        testcd == "ICU28D",
        "28-day",
        paste0(gsub("ICU", "", testcd), "-day")
      ),
      " all-cause mortality"
    ),
    "ROC curve analysis of the incremental effect of FI-Lab on in-hospital mortality"
  )
  
  
  # åˆ›å»ºå­˜å‚¨å›¾å½¢çš„åˆ—è¡¨
  plot_list <- list()
  
  # è®¾ç½®SCIæ–‡çŒ®é…è‰²æ–¹æ¡ˆ
  sci_colors <- brewer.pal(8, "Set1")[c(1, 2)]
  
  # å¯¹æ¯ä¸ªè¯„åˆ†ç³»ç»Ÿè¿›è¡Œå¤„ç†
  for (i in seq_along(scores)) {
    score <- scores[i]
    
    # æ„å»ºæ¨¡å‹å…¬å¼
    original_formula <- as.formula(paste("Surv(time, event) ~", score))
    enhanced_formula <- as.formula(paste("Surv(time, event) ~", score, "+ flab100"))
    
    # é…ç½®æ•°æ®ç¯å¢ƒ
    ddist <- datadist(data)
    options(datadist = ddist)
    
    # æ‹Ÿåˆæ¨¡å‹
    original_model <- cph(original_formula, data = data, x = TRUE, y = TRUE, surv = TRUE, time.inc = time_point)
    enhanced_model <- cph(enhanced_formula, data = data, x = TRUE, y = TRUE, surv = TRUE, time.inc = time_point)
    
    # è·å–é¢„æµ‹å€¼
    data$pred_original <- predict(original_model, type = "lp")
    data$pred_enhanced <- predict(enhanced_model, type = "lp")
    
    # è®¡ç®—ROCæ›²çº¿å’ŒAUC
    roc_original <- timeROC(T = data$time,
                            delta = data$event,
                            marker = data$pred_original,
                            cause = 1,
                            weighting = "marginal",
                            iid = TRUE,
                            times = time_point)
    
    roc_enhanced <- timeROC(T = data$time,
                            delta = data$event,
                            marker = data$pred_enhanced,
                            cause = 1,
                            weighting = "marginal",
                            iid = TRUE,
                            times = time_point)
    
    # è®¡ç®—AUCæ¯”è¾ƒçš„På€¼
    auc_diff_test <- compare(roc_original, roc_enhanced)
    p_value <- auc_diff_test$p_values_AUC[2]
    
    # æ­£ç¡®è®¡ç®—ç½®ä¿¡åŒºé—´å¹¶æå–t=27çš„å€¼
    roc_original_ci <- confint(roc_original)
    roc_enhanced_ci <- confint(roc_enhanced)
    
    # ä¿®æ”¹åçš„get_ciå‡½æ•°ï¼ˆä¸“é—¨å¤„ç†åˆ—è¡¨ç»“æ„ï¼‰
    get_ci <- function(ci_list) {
      # 1. éªŒè¯è¾“å…¥ç»“æ„
      if (!is.list(ci_list) || !all(c("CI_AUC", "CB_AUC") %in% names(ci_list))) {
        stop("è¾“å…¥å¿…é¡»æ˜¯åŒ…å«CLAUCå’ŒCB_AUCå…ƒç´ çš„åˆ—è¡¨")
      }
      
      # 2. æå–CLAUCçŸ©é˜µï¼ˆæ ¹æ®æ‚¨çš„ç»“æ„ï¼‰
      clauc_matrix <- ci_list$CI_AUC
      last_n<-nrow(clauc_matrix)
      # # 3. éªŒè¯çŸ©é˜µç»“æ„ HOSPXXD is 1X2, only t=27
      # if (!is.matrix(clauc_matrix) || nrow(clauc_matrix) != 2 || ncol(clauc_matrix) != 2) {
      #   stop("CLAUCå…ƒç´ å¿…é¡»æ˜¯2x2çŸ©é˜µ")
      # }
      
      # 4. æå–ç½®ä¿¡åŒºé—´å€¼ï¼ˆå‡è®¾æœ€åä¸€è¡Œæ˜¯t=27ï¼‰
      # ç¬¬ä¸€è¡Œå¯èƒ½æ˜¯t=0æˆ–å…¶ä»–æ—¶é—´ç‚¹ï¼Œç¬¬äºŒè¡Œæ˜¯t=27
      ci_row <- clauc_matrix[last_n, ]  # è·å–ç¬¬äºŒè¡Œæ•°æ®
      ci_lower <- ci_row[1] / 100  # ç¬¬ä¸€åˆ—æ˜¯2.5%
      ci_upper <- ci_row[2] / 100  # ç¬¬äºŒåˆ—æ˜¯97.5%
      
      return(c(ci_lower, ci_upper))
    }
    # ä½¿ç”¨ç¤ºä¾‹
    ci_original <- get_ci(roc_original_ci)  # è¾“å…¥æ˜¯åˆ—è¡¨
    ci_enhanced <- get_ci(roc_enhanced_ci)
    
    # åˆ›å»ºROCæ›²çº¿æ•°æ®æ¡†
    roc_points <- min(nrow(roc_original$TP), nrow(roc_enhanced$TP))
    roc_df <- data.frame(
      Sensitivity = c(
        roc_original$TP[1:roc_points, 2], 
        roc_enhanced$TP[1:roc_points, 2]
      ),
      Specificity = c(
        1 - roc_original$FP[1:roc_points, 2], 
        1 - roc_enhanced$FP[1:roc_points, 2]
      ),
      Model = rep(
        c(paste0(toupper(score)), 
          paste0(toupper(score), " + FI-Lab")), 
        each = roc_points
      )
    )
    #
    
    
    # åˆ›å»ºæ’å€¼å‡½æ•°è§£å†³æ›²çº¿ç‚¹æ•°ä¸ä¸€è‡´é—®é¢˜
    interpolate_roc <- function(roc_obj, n_points = 300) {
      fpr <- roc_obj$FP[, 2]
      tpr <- roc_obj$TP[, 2]
      
      # æŒ‰FPRæ’åº
      ord <- order(fpr)
      fpr <- fpr[ord]
      tpr <- tpr[ord]
      
      # ç”Ÿæˆç»Ÿä¸€çš„FPRåºåˆ—
      unified_fpr <- seq(0, 1, length.out = n_points)
      
      # çº¿æ€§æ’å€¼è·å–TPR
      unified_tpr <- approx(fpr, tpr, xout = unified_fpr, method = "linear", rule = 2)$y
      
      data.frame(FPR = unified_fpr, TPR = unified_tpr)
    }
    
    # åº”ç”¨æ’å€¼
    roc_orig_interp <- interpolate_roc(roc_original)
    roc_enh_interp <- interpolate_roc(roc_enhanced)
    
    # åˆ›å»ºROCæ•°æ®æ¡†
    roc_df <- data.frame(
      Sensitivity = c(roc_orig_interp$TPR, roc_enh_interp$TPR),
      Specificity = 1 - c(roc_orig_interp$FPR, roc_enh_interp$FPR),
      Model = rep(c(paste0(toupper(score)), 
                    paste0(toupper(score), " + FI-Lab")), 
                  each = nrow(roc_orig_interp))
    )
    
    # åˆ›å»ºAUCæ ‡ç­¾
    is_significant <- p_value < 0.05
    significance_star <- ifelse(is_significant, "*", "")
    
    auc_label <- sprintf(
      "AUC 1: %.3f (%.3f-%.3f)%s\nAUC 2: %.3f (%.3f-%.3f)%s\n%s",
      roc_original$AUC[2], ci_original[1], ci_original[2], ifelse(is_significant, "", " "),
      roc_enhanced$AUC[2], ci_enhanced[1], ci_enhanced[2], ifelse(is_significant, "*", ""),
      ifelse(p_value < 0.001, 
             "P < 0.001", 
             sprintf("P = %.3f", p_value))
      
    )
    

    # åˆ›å»ºggplotå¯¹è±¡
    p <- ggplot(roc_df, aes(x = 1 - Specificity, y = Sensitivity, color = Model)) +
      geom_line(linewidth = 1.2) +
      geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "gray50") +
      scale_color_manual(values = sci_colors) +
      labs(title = paste0(toupper(score), " Score + FI-Lab"),  # ä¿®æ”¹æ ‡é¢˜æ ¼å¼
           x = "1 - Specificity",
           y = "Sensitivity") +
      theme_minimal(base_size = 12) +
      theme(
        plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
        legend.position = c(0.75, 0.10),  # å°†å›¾ä¾‹ç§»åˆ°å›¾å†…
        legend.title = element_blank(),
        legend.background = element_rect(fill = "white", color = NA),
        panel.grid.minor = element_blank(),
        panel.border = element_rect(fill = NA, color = "black")
      ) +
      coord_equal() +
      # æ·»åŠ AUCæ–‡æœ¬æ ‡ç­¾åˆ°å›¾å†…
      annotate("text", x = 0.5, y = 0.5, label = auc_label, 
               size = 3.5, hjust = 0, vjust = 1,color = "black")
    # æ·»åŠ åŠé€æ˜èƒŒæ™¯æ¡†ç¡®ä¿æ–‡æœ¬å¯è¯»æ€§
    # annotate("rect", 
    #          xmin = 0.55, 
    #          xmax = 0.95,
    #          ymin = 0.15, 
    #          ymax = 0.35,
    #          alpha = 0.2, 
    #          fill = "white")
    
    plot_list[[i]] <- p
  }
  
  # ç»„åˆæ‰€æœ‰å›¾å½¢
  combined_plot <- grid.arrange(grobs = plot_list, ncol = 3, 
                                top = grid::textGrob(title_text, 
                                                     gp = grid::gpar(fontsize = 16, fontface = "bold")))
  
  # ä¿å­˜ä¸ºä¸åŒæ ¼å¼
  formats <- c("png", "jpg", "svg", "tiff")
  for (fmt in formats) {
    filename <- paste0("Roc_plots/ROC-", testcd, ".", fmt)
    ggsave(filename, combined_plot, width = 16, height = 10, dpi = 300)
  }
  
  return(paste0("ROC-", testcd, ".", formats))
}

# ä¸»åˆ†æå‡½æ•°ä¿æŒä¸å˜
analyze_and_generate <- function(testcd, time_point) {
  # é…ç½®å‚æ•°
  scores <- c("apsiii", "sapsii", "oasis", "sofa", "sirs", "gcs")
  
  # æ•°æ®å¤„ç†
  analysis_data <- tte %>%
    filter(testcd == !!testcd) %>%
    select(-any_of(c("Q1", "Q2", "Q3", "Q4"))) %>%
    mutate(flab100 = as.numeric(flab100)) %>% 
    filter(!is.na(flab100)) %>%
    mutate(time = as.numeric(aval),
           event = as.numeric(cnsr))
  
  # ç”ŸæˆROCæ›²çº¿
  roc_files <- generate_roc_plots(testcd, time_point, scores, analysis_data)
  
  return(roc_files)
}

# æ‰§è¡Œåˆ†æå¹¶ç”Ÿæˆå›¾å½¢
# ICU28Dåˆ†æ
icu_files <- analyze_and_generate(testcd = "ICU28D", time_point = 27)

# HOSPXXDåˆ†æ
hosp_files <- analyze_and_generate(testcd = "HOSPXXD", time_point = 27)

# è¾“å‡ºç»“æœ
message("ç”Ÿæˆå®Œæˆ:")
message("ICU28Dæ–‡ä»¶: ", paste(icu_files, collapse = ", "))
message("HOSPXXDæ–‡ä»¶: ", paste(hosp_files, collapse = ", "))

```

# SHAP+BORUTA

## Boruta feature selection

```{r}
# åŠ è½½å¿…è¦çš„åŒ…
library(Boruta)       # ç‰¹å¾é€‰æ‹©
library(randomForest) # éšæœºæ£®æ—
library(haven)        # è¯»å–SASæ•°æ®
library(readxl)       # è¯»å–Excelæ–‡ä»¶
library(dplyr)        # æ•°æ®å¤„ç†
library(tidyr)        # æ•°æ®æ•´ç†
library(forcats)      # å› å­å¤„ç†

# ======================
# æ•°æ®éªŒè¯å‡½æ•°
# ======================
validate_data <- function(tte_df, metadata) {
  if (!is.data.frame(tte_df)) stop("tte_dfå¿…é¡»æ˜¯æ•°æ®æ¡†")
  required_tte_cols <- c('testcd', 'aval', 'cnsr', 'flab100')
  missing_tte_cols <- setdiff(required_tte_cols, colnames(tte_df))
  if (length(missing_tte_cols) > 0) {
    stop("tte_dfç¼ºå°‘å¿…è¦åˆ—: ", paste(missing_tte_cols, collapse = ", "))
  }
  
  if (!is.data.frame(metadata)) stop("metadataå¿…é¡»æ˜¯æ•°æ®æ¡†")
  required_meta_cols <- c("xvar", "variable_name")
  missing_meta_cols <- setdiff(required_meta_cols, colnames(metadata))
  if (length(missing_meta_cols) > 0) {
    stop("metadataç¼ºå°‘å¿…è¦åˆ—: ", paste(missing_meta_cols, collapse = ", "))
  }
  
  xvar_names <- metadata %>%
    filter(xvar == 1) %>%
    pull(variable_name)
  
  if (length(xvar_names) == 0) {
    stop("metadataä¸­æ²¡æœ‰æ ‡è®°ä¸ºxvar=1çš„è‡ªå˜é‡")
  }
  
  cat("æˆåŠŸéªŒè¯æ•°æ®:\n")
  cat("  tte_df:", nrow(tte_df), "è¡Œ", ncol(tte_df), "åˆ—\n")
  cat("  metadata:", nrow(metadata), "è¡Œ\n")
  cat("  æ‰¾åˆ°", length(xvar_names), "ä¸ªè‡ªå˜é‡\n")
  
  return(xvar_names)
}

# ======================
# Borutaåˆ†æå‡½æ•°ï¼ˆä½¿ç”¨åŸç”Ÿplotæ–¹æ³•ï¼‰
# ======================
run_boruta_analysis <- function(testcd, tte_df, xvar_names) {
  cat("\n", rep("=", 50), "\n", sep="")
  cat("å¤„ç†", testcd, "...\n")
  cat(rep("=", 50), "\n\n", sep="")
  
  # æå–ç‰¹å®štestcdçš„æ•°æ®
  test_data <- tte_df %>%
    filter(testcd == !!testcd) %>%
    select(-any_of(c('Q1','Q2','Q3','Q4')))
  
  cat("  ", testcd, "æ•°æ®é›†å¤§å°:", nrow(test_data), "è¡Œ\n")
  
  # æ¸…ç†flab100
  test_data$flab100 <- as.numeric(test_data$flab100)
  test_data <- test_data[!is.na(test_data$flab100), ]
  cat("  æ¸…ç†åæ•°æ®é›†å¤§å°:", nrow(test_data), "è¡Œ\n")
  
  # åˆ›å»ºäºŒåˆ†ç±»ç›®æ ‡
  median_time <- median(test_data$aval)
  binary_target <- ifelse(test_data$cnsr == 1 & test_data$aval <= median_time, 1, 0)
  cat("  äºŒåˆ†ç±»ç›®æ ‡åˆ†å¸ƒ: \n")
  print(table(binary_target))
  
  # æå–è‡ªå˜é‡æ•°æ®
  available_xvar <- intersect(xvar_names, colnames(test_data))
  X <- test_data[, available_xvar] %>%
    mutate(across(everything(), as.numeric))
  
  cat("  ä½¿ç”¨çš„è‡ªå˜é‡:", length(available_xvar), "/", length(xvar_names), "\n")
  
  # è¿è¡ŒBoruta
  cat("  è¿è¡ŒBorutaç‰¹å¾é€‰æ‹©...\n")
  set.seed(42)
  boruta_result <- Boruta(
    x = X,
    y = factor(binary_target),
    doTrace = 2,
    maxRuns = 200,
    getImp = getImpRfZ
  )
  
  # åˆ›å»ºè¾“å‡ºç›®å½•
  output_dir <- "Feature_selection/boxplot"
  if (!dir.exists(output_dir)) dir.create(output_dir, recursive = TRUE)
  
  # åŸºç¡€æ–‡ä»¶å
  base_path <- file.path(output_dir, paste0(testcd, "_Boruta"))
  
  # ======================
  # ä½¿ç”¨BorutaåŸç”Ÿplotæ–¹æ³•ç»˜å›¾
  # ======================
  save_boruta_plot <- function(file_path, testcd, width = 14, height = 10) {
    # 1. åŠ¨æ€è®¡ç®—å‚æ•°
    sci_colors <- c(Confirmed="#1F77B4", Tentative="#FF7F0E", 
                    Rejected="#D62728", Shadow="#D3D3D3")
    
    # è·å–çœŸå®ç‰¹å¾ï¼ˆæ’é™¤å½±å­ç‰¹å¾ï¼‰
    features <- rownames(attStats(boruta_result))
    real_features <- features[!grepl("^shadow", features)]
    n_features <- length(features)
    
    # 3. åŠ¨æ€è¾¹è·è®¡ç®—ï¼ˆæ ¹æ®ç‰¹å¾æ•°é‡ï¼‰
    bottom_margin <- max(20, 8 + n_features * 0.3)  # æ¯ç‰¹å¾å¢åŠ 0.3å•ä½è¾¹è·
    right_margin <- max(10, 8 + n_features * 0.1)   # ä¸ºå›¾ä¾‹é¢„ç•™ç©ºé—´
    
    # é‡æ„ç»˜å›¾å‡½æ•°
    plot_boruta <- function() {
      # åŠ¨æ€è°ƒæ•´è¾¹è·
      bottom_margin <- max(15, 8 + n_features * 0.3)
      right_margin <- max(10, 8 + n_features * 0.1)
      
      par(
        mar = c(bottom_margin, 8, 8, right_margin) + 0.1,
        xpd = TRUE,
        cex.axis = 1.1,
        cex.lab = 1.3,
        cex.main = 1.5
      )
      
      plot(boruta_result, main = ifelse(testcd == "ICU28D", 
                                        "Boruta Feature Importance - 28-day all-cause mortality",
                                        "Boruta Feature Importance - In-hospital mortality"),
           sort=T,
           colCode = sci_colors,
           whichShadow=c(T,T,T),
           cex.axis=0.8, 
           las=2, 
           xlab=" ", 
           ylab = "Z-Score Importance")
      
      mtext("Variables", side = 1, 
            line = 5,                   # å…³é”®ï¼šæå‡æ ‡ç­¾ä½ç½®
            cex = 1.2)                  # é€‚å½“æ”¾å¤§
      
      # å®Œæ•´å›¾ä¾‹
      legend("topright",
             inset = c(-0.18, 0),
             legend = c("Confirmed", "Tentative", "Rejected", "Shadow"),
             fill = sci_colors,
             title = "Decision",
             cex = 0.8)
    }
    
    # 5. å¤šæ ¼å¼ä¿å­˜
    img_formats <- c("png", "jpg", "tiff", "svg")
    for (fmt in img_formats) {
      output_file <- paste0(file_path, ".", fmt)
      
      if (fmt %in% c("png", "jpg", "tiff")) {
        # åŠ¨æ€å°ºå¯¸ï¼šç‰¹å¾è¶Šå¤šå›¾åƒè¶Šé«˜
        res <- 300
        height_adj <- max(10, n_features * 0.4)  # æ¯ç‰¹å¾0.4è‹±å¯¸é«˜åº¦
        width_px <- width * res
        height_px <- height_adj * res
        
        if (fmt == "png") png(output_file, width = width_px, height = height_px, res = res)
        if (fmt == "jpg") jpeg(output_file, width = width_px, height = height_px, res = res)
        if (fmt == "tiff") tiff(output_file, width = width_px, height = height_px, res = res)
      } else {
        svg(output_file, width = width, height = max(10, n_features * 0.4))
      }
      
      plot_boruta()
      dev.off()
    }
    cat("ä¼˜åŒ–å›¾åƒå·²ä¿å­˜:", paste0(file_path, ".{", paste(img_formats, collapse = ","), "}\n"))
  }
  # Save plots
  save_boruta_plot(base_path,testcd)
  cat("  Plots saved in four formats: PNG, JPG, SVG, TIFF\n")
  # Save CSV results
  imp_df <- attStats(boruta_result) %>%
    as.data.frame() %>%
    tibble::rownames_to_column("feature") %>%
    select(feature, boruta_decision = decision, boruta_ranking = medianImp)
  
  write.csv(imp_df, paste0(base_path, "_Results.csv"), row.names = FALSE)
  cat("  Boruta results saved to: ", base_path, "_Results.csv\n", sep = "")
  
  
  return(boruta_result)
}
# ======================
# ä¸»æ‰§è¡Œæµç¨‹
# ======================
tte_df <- tte  # ä»ç¯å¢ƒè·å–æ•°æ®

# éªŒè¯æ•°æ®å¹¶è·å–è‡ªå˜é‡åˆ—è¡¨
xvar_names <- validate_data(tte_df, metadata)

# ç›®æ ‡testcdï¼ˆåªå¤„ç†ICU28Då’ŒHOSPXXDï¼‰
target_testcds <- c('ICU28D',"HOSPXXD")
all_testcds <- unique(tte_df$testcd)

cat("\nå¼€å§‹å¤„ç†æŒ‡å®šæµ‹è¯•æŒ‡æ ‡:\n")
for (testcd in target_testcds) {
  if (testcd %in% all_testcds) {
    cat("\n", rep("=", 30), "\n", sep="")
    cat("å¤„ç†", testcd, "\n")
    cat(rep("=", 30), "\n\n", sep="")
    boruta_result <- run_boruta_analysis(testcd, tte_df, xvar_names)
  } else {
    cat("è·³è¿‡ '", testcd, "'ï¼Œå› å…¶ä¸åœ¨æ•°æ®ä¸­\n", sep="")
  }
}

cat("\nåˆ†æå®Œæˆ! æ‰€æœ‰ç»“æœä¿å­˜è‡³ Feature_selection/boxplot ç›®å½•\n")

```

## SHAP: è§Pythonä»£ç 
